"use strict";
/*!
 * Copyright 2019 Omar Tawfik. Please see LICENSE file at the root of this repository.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tokens_1 = require("./tokens");
var vscode_languageserver_types_1 = require("vscode-languageserver-types");
function scanText(text, bag) {
    var index = 0;
    var line = 0;
    var character = 0;
    var tokens = [];
    while (index < text.length) {
        scanNextToken();
    }
    return tokens;
    function scanNextToken() {
        var current = text[index];
        switch (current) {
            case "\r": {
                if (index + 1 < text.length && text[index + 1] === "\n") {
                    index += 2;
                }
                else {
                    index += 1;
                }
                line += 1;
                character = 0;
                break;
            }
            case "\n": {
                index += 1;
                line += 1;
                character = 0;
                break;
            }
            case " ":
            case "\t": {
                index += 1;
                character += 1;
                break;
            }
            case "=": {
                addToken(tokens_1.TokenKind.Equal, current);
                break;
            }
            case ",": {
                addToken(tokens_1.TokenKind.Comma, current);
                break;
            }
            case "{": {
                addToken(tokens_1.TokenKind.LeftCurlyBracket, current);
                break;
            }
            case "}": {
                addToken(tokens_1.TokenKind.RightCurlyBracket, current);
                break;
            }
            case "[": {
                addToken(tokens_1.TokenKind.LeftSquareBracket, current);
                break;
            }
            case "]": {
                addToken(tokens_1.TokenKind.RightSquareBracket, current);
                break;
            }
            case "#": {
                scanComment();
                break;
            }
            case "/": {
                if (index + 1 < text.length && text[index + 1] === "/") {
                    scanComment();
                }
                else {
                    var token = addToken(tokens_1.TokenKind.Unrecognized, current);
                    bag.unrecognizedCharacter(current, token.range);
                }
                break;
            }
            case '"': {
                scanStringLiteral();
                break;
            }
            default: {
                if ("0" <= current && current <= "9") {
                    scanNumberLiteral();
                }
                else if (current === "_" || ("a" <= current && current <= "z") || ("A" <= current && current <= "Z")) {
                    scanKeywordOrIdentifier();
                }
                else {
                    var token = addToken(tokens_1.TokenKind.Unrecognized, current);
                    bag.unrecognizedCharacter(current, token.range);
                }
                break;
            }
        }
    }
    function scanComment() {
        var lookAhead = index + 1;
        while (lookAhead < text.length) {
            var current = text[lookAhead];
            if (current === "\r" || current === "\n") {
                break;
            }
            lookAhead += 1;
        }
        addToken(tokens_1.TokenKind.Comment, text.substring(index, lookAhead));
    }
    function scanStringLiteral() {
        var lookAhead = index + 1;
        while (lookAhead < text.length) {
            var current = text[lookAhead];
            switch (current) {
                case '"': {
                    addToken(tokens_1.TokenKind.StringLiteral, text.substring(index, lookAhead + 1));
                    return;
                }
                case "\r":
                case "\n": {
                    var token_1 = addToken(tokens_1.TokenKind.StringLiteral, text.substring(index, lookAhead));
                    bag.unterminatedStringLiteral(token_1.range);
                    return;
                }
                case "\\": {
                    if (lookAhead + 1 < text.length) {
                        var escaped = text[lookAhead + 1];
                        switch (escaped) {
                            case "\\":
                            case "/":
                            case '"':
                            case "b":
                            case "f":
                            case "n":
                            case "r":
                            case "t": {
                                break;
                            }
                            default: {
                                bag.unsupportedEscapeSequence(escaped, getRange(lookAhead + 1, 1));
                                break;
                            }
                        }
                        lookAhead += 2;
                    }
                    else {
                        lookAhead += 1;
                    }
                    break;
                }
                default: {
                    if (current === "\u007F" || ("\u0000" <= current && current <= "\u001F")) {
                        bag.unrecognizedCharacter(current, getRange(lookAhead, 1));
                    }
                    lookAhead += 1;
                    break;
                }
            }
        }
        var token = addToken(tokens_1.TokenKind.StringLiteral, text.substring(index, lookAhead));
        bag.unterminatedStringLiteral(token.range);
    }
    function scanNumberLiteral() {
        var lookAhead = index + 1;
        while (lookAhead < text.length) {
            var current = text[lookAhead];
            if ("0" <= current && current <= "9") {
                lookAhead += 1;
            }
            else {
                break;
            }
        }
        addToken(tokens_1.TokenKind.IntegerLiteral, text.substring(index, lookAhead));
    }
    function scanKeywordOrIdentifier() {
        var lookAhead = index + 1;
        while (lookAhead < text.length) {
            var current = text[lookAhead];
            if (current === "_" ||
                ("a" <= current && current <= "z") ||
                ("A" <= current && current <= "Z") ||
                ("0" <= current && current <= "9")) {
                lookAhead += 1;
            }
            else {
                break;
            }
        }
        var length = lookAhead - index;
        var value = text.substr(index, length);
        switch (value) {
            case "version": {
                addToken(tokens_1.TokenKind.VersionKeyword, value);
                break;
            }
            case "workflow": {
                addToken(tokens_1.TokenKind.WorkflowKeyword, value);
                break;
            }
            case "action": {
                addToken(tokens_1.TokenKind.ActionKeyword, value);
                break;
            }
            case "on": {
                addToken(tokens_1.TokenKind.OnKeyword, value);
                break;
            }
            case "resolves": {
                addToken(tokens_1.TokenKind.ResolvesKeyword, value);
                break;
            }
            case "uses": {
                addToken(tokens_1.TokenKind.UsesKeyword, value);
                break;
            }
            case "needs": {
                addToken(tokens_1.TokenKind.NeedsKeyword, value);
                break;
            }
            case "runs": {
                addToken(tokens_1.TokenKind.RunsKeyword, value);
                break;
            }
            case "args": {
                addToken(tokens_1.TokenKind.ArgsKeyword, value);
                break;
            }
            case "env": {
                addToken(tokens_1.TokenKind.EnvKeyword, value);
                break;
            }
            case "secrets": {
                addToken(tokens_1.TokenKind.SecretsKeyword, value);
                break;
            }
            default: {
                addToken(tokens_1.TokenKind.Identifier, value);
                break;
            }
        }
    }
    function addToken(kind, contents) {
        var token = {
            kind: kind,
            text: contents,
            range: getRange(character, contents.length),
        };
        index += contents.length;
        character += contents.length;
        tokens.push(token);
        return token;
    }
    function getRange(character, length) {
        return vscode_languageserver_types_1.Range.create(line, character, line, character + length);
    }
}
exports.scanText = scanText;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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TUFBQTtZQUNKLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLFFBQVEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQztTQUM1QyxDQUFDO1FBRUYsS0FBSyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDekIsU0FBUyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFFN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxTQUFTLFFBQVEsQ0FBQyxTQUFpQixFQUFFLE1BQWM7UUFDakQsT0FBTyxtQ0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUM7SUFDakUsQ0FBQztBQUNILENBQUM7QUExUUQsNEJBMFFDIiwiZmlsZSI6InNyYy9zY2FubmluZy9zY2FubmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgMjAxOSBPbWFyIFRhd2Zpay4gUGxlYXNlIHNlZSBMSUNFTlNFIGZpbGUgYXQgdGhlIHJvb3Qgb2YgdGhpcyByZXBvc2l0b3J5LlxuICovXG5cbmltcG9ydCB7IERpYWdub3N0aWNCYWcgfSBmcm9tIFwiLi4vdXRpbC9kaWFnbm9zdGljc1wiO1xuaW1wb3J0IHsgVG9rZW4sIFRva2VuS2luZCB9IGZyb20gXCIuL3Rva2Vuc1wiO1xuaW1wb3J0IHsgUmFuZ2UgfSBmcm9tIFwidnNjb2RlLWxhbmd1YWdlc2VydmVyLXR5cGVzXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBzY2FuVGV4dCh0ZXh0OiBzdHJpbmcsIGJhZzogRGlhZ25vc3RpY0JhZyk6IFJlYWRvbmx5QXJyYXk8VG9rZW4+IHtcbiAgbGV0IGluZGV4OiBudW1iZXIgPSAwO1xuICBsZXQgbGluZTogbnVtYmVyID0gMDtcbiAgbGV0IGNoYXJhY3RlcjogbnVtYmVyID0gMDtcblxuICBjb25zdCB0b2tlbnM6IFRva2VuW10gPSBbXTtcblxuICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkge1xuICAgIHNjYW5OZXh0VG9rZW4oKTtcbiAgfVxuXG4gIHJldHVybiB0b2tlbnM7XG5cbiAgZnVuY3Rpb24gc2Nhbk5leHRUb2tlbigpOiB2b2lkIHtcbiAgICBjb25zdCBjdXJyZW50ID0gdGV4dFtpbmRleF07XG5cbiAgICBzd2l0Y2ggKGN1cnJlbnQpIHtcbiAgICAgIGNhc2UgXCJcXHJcIjoge1xuICAgICAgICBpZiAoaW5kZXggKyAxIDwgdGV4dC5sZW5ndGggJiYgdGV4dFtpbmRleCArIDFdID09PSBcIlxcblwiKSB7XG4gICAgICAgICAgaW5kZXggKz0gMjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbmRleCArPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgbGluZSArPSAxO1xuICAgICAgICBjaGFyYWN0ZXIgPSAwO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJcXG5cIjoge1xuICAgICAgICBpbmRleCArPSAxO1xuICAgICAgICBsaW5lICs9IDE7XG4gICAgICAgIGNoYXJhY3RlciA9IDA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcIiBcIjpcbiAgICAgIGNhc2UgXCJcXHRcIjoge1xuICAgICAgICBpbmRleCArPSAxO1xuICAgICAgICBjaGFyYWN0ZXIgKz0gMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwiPVwiOiB7XG4gICAgICAgIGFkZFRva2VuKFRva2VuS2luZC5FcXVhbCwgY3VycmVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcIixcIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuQ29tbWEsIGN1cnJlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJ7XCI6IHtcbiAgICAgICAgYWRkVG9rZW4oVG9rZW5LaW5kLkxlZnRDdXJseUJyYWNrZXQsIGN1cnJlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJ9XCI6IHtcbiAgICAgICAgYWRkVG9rZW4oVG9rZW5LaW5kLlJpZ2h0Q3VybHlCcmFja2V0LCBjdXJyZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwiW1wiOiB7XG4gICAgICAgIGFkZFRva2VuKFRva2VuS2luZC5MZWZ0U3F1YXJlQnJhY2tldCwgY3VycmVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcIl1cIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuUmlnaHRTcXVhcmVCcmFja2V0LCBjdXJyZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwiI1wiOiB7XG4gICAgICAgIHNjYW5Db21tZW50KCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcIi9cIjoge1xuICAgICAgICBpZiAoaW5kZXggKyAxIDwgdGV4dC5sZW5ndGggJiYgdGV4dFtpbmRleCArIDFdID09PSBcIi9cIikge1xuICAgICAgICAgIHNjYW5Db21tZW50KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgdG9rZW4gPSBhZGRUb2tlbihUb2tlbktpbmQuVW5yZWNvZ25pemVkLCBjdXJyZW50KTtcbiAgICAgICAgICBiYWcudW5yZWNvZ25pemVkQ2hhcmFjdGVyKGN1cnJlbnQsIHRva2VuLnJhbmdlKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ1wiJzoge1xuICAgICAgICBzY2FuU3RyaW5nTGl0ZXJhbCgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgaWYgKFwiMFwiIDw9IGN1cnJlbnQgJiYgY3VycmVudCA8PSBcIjlcIikge1xuICAgICAgICAgIHNjYW5OdW1iZXJMaXRlcmFsKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoY3VycmVudCA9PT0gXCJfXCIgfHwgKFwiYVwiIDw9IGN1cnJlbnQgJiYgY3VycmVudCA8PSBcInpcIikgfHwgKFwiQVwiIDw9IGN1cnJlbnQgJiYgY3VycmVudCA8PSBcIlpcIikpIHtcbiAgICAgICAgICBzY2FuS2V5d29yZE9ySWRlbnRpZmllcigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHRva2VuID0gYWRkVG9rZW4oVG9rZW5LaW5kLlVucmVjb2duaXplZCwgY3VycmVudCk7XG4gICAgICAgICAgYmFnLnVucmVjb2duaXplZENoYXJhY3RlcihjdXJyZW50LCB0b2tlbi5yYW5nZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gc2NhbkNvbW1lbnQoKTogdm9pZCB7XG4gICAgbGV0IGxvb2tBaGVhZCA9IGluZGV4ICsgMTtcbiAgICB3aGlsZSAobG9va0FoZWFkIDwgdGV4dC5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSB0ZXh0W2xvb2tBaGVhZF07XG4gICAgICBpZiAoY3VycmVudCA9PT0gXCJcXHJcIiB8fCBjdXJyZW50ID09PSBcIlxcblwiKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBsb29rQWhlYWQgKz0gMTtcbiAgICB9XG5cbiAgICBhZGRUb2tlbihUb2tlbktpbmQuQ29tbWVudCwgdGV4dC5zdWJzdHJpbmcoaW5kZXgsIGxvb2tBaGVhZCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gc2NhblN0cmluZ0xpdGVyYWwoKTogdm9pZCB7XG4gICAgbGV0IGxvb2tBaGVhZCA9IGluZGV4ICsgMTtcbiAgICB3aGlsZSAobG9va0FoZWFkIDwgdGV4dC5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSB0ZXh0W2xvb2tBaGVhZF07XG4gICAgICBzd2l0Y2ggKGN1cnJlbnQpIHtcbiAgICAgICAgY2FzZSAnXCInOiB7XG4gICAgICAgICAgYWRkVG9rZW4oVG9rZW5LaW5kLlN0cmluZ0xpdGVyYWwsIHRleHQuc3Vic3RyaW5nKGluZGV4LCBsb29rQWhlYWQgKyAxKSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJcXHJcIjpcbiAgICAgICAgY2FzZSBcIlxcblwiOiB7XG4gICAgICAgICAgY29uc3QgdG9rZW4gPSBhZGRUb2tlbihUb2tlbktpbmQuU3RyaW5nTGl0ZXJhbCwgdGV4dC5zdWJzdHJpbmcoaW5kZXgsIGxvb2tBaGVhZCkpO1xuICAgICAgICAgIGJhZy51bnRlcm1pbmF0ZWRTdHJpbmdMaXRlcmFsKHRva2VuLnJhbmdlKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcIlxcXFxcIjoge1xuICAgICAgICAgIGlmIChsb29rQWhlYWQgKyAxIDwgdGV4dC5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGVzY2FwZWQgPSB0ZXh0W2xvb2tBaGVhZCArIDFdO1xuICAgICAgICAgICAgc3dpdGNoIChlc2NhcGVkKSB7XG4gICAgICAgICAgICAgIGNhc2UgXCJcXFxcXCI6XG4gICAgICAgICAgICAgIGNhc2UgXCIvXCI6XG4gICAgICAgICAgICAgIGNhc2UgJ1wiJzpcbiAgICAgICAgICAgICAgY2FzZSBcImJcIjpcbiAgICAgICAgICAgICAgY2FzZSBcImZcIjpcbiAgICAgICAgICAgICAgY2FzZSBcIm5cIjpcbiAgICAgICAgICAgICAgY2FzZSBcInJcIjpcbiAgICAgICAgICAgICAgY2FzZSBcInRcIjoge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICBiYWcudW5zdXBwb3J0ZWRFc2NhcGVTZXF1ZW5jZShlc2NhcGVkLCBnZXRSYW5nZShsb29rQWhlYWQgKyAxLCAxKSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxvb2tBaGVhZCArPSAyO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb29rQWhlYWQgKz0gMTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgIGlmIChjdXJyZW50ID09PSBcIlxcdTAwN0ZcIiB8fCAoXCJcXHUwMDAwXCIgPD0gY3VycmVudCAmJiBjdXJyZW50IDw9IFwiXFx1MDAxRlwiKSkge1xuICAgICAgICAgICAgYmFnLnVucmVjb2duaXplZENoYXJhY3RlcihjdXJyZW50LCBnZXRSYW5nZShsb29rQWhlYWQsIDEpKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsb29rQWhlYWQgKz0gMTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHRva2VuID0gYWRkVG9rZW4oVG9rZW5LaW5kLlN0cmluZ0xpdGVyYWwsIHRleHQuc3Vic3RyaW5nKGluZGV4LCBsb29rQWhlYWQpKTtcbiAgICBiYWcudW50ZXJtaW5hdGVkU3RyaW5nTGl0ZXJhbCh0b2tlbi5yYW5nZSk7XG4gIH1cblxuICBmdW5jdGlvbiBzY2FuTnVtYmVyTGl0ZXJhbCgpOiB2b2lkIHtcbiAgICBsZXQgbG9va0FoZWFkID0gaW5kZXggKyAxO1xuICAgIHdoaWxlIChsb29rQWhlYWQgPCB0ZXh0Lmxlbmd0aCkge1xuICAgICAgY29uc3QgY3VycmVudCA9IHRleHRbbG9va0FoZWFkXTtcbiAgICAgIGlmIChcIjBcIiA8PSBjdXJyZW50ICYmIGN1cnJlbnQgPD0gXCI5XCIpIHtcbiAgICAgICAgbG9va0FoZWFkICs9IDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRUb2tlbihUb2tlbktpbmQuSW50ZWdlckxpdGVyYWwsIHRleHQuc3Vic3RyaW5nKGluZGV4LCBsb29rQWhlYWQpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNjYW5LZXl3b3JkT3JJZGVudGlmaWVyKCk6IHZvaWQge1xuICAgIGxldCBsb29rQWhlYWQgPSBpbmRleCArIDE7XG4gICAgd2hpbGUgKGxvb2tBaGVhZCA8IHRleHQubGVuZ3RoKSB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGV4dFtsb29rQWhlYWRdO1xuICAgICAgaWYgKFxuICAgICAgICBjdXJyZW50ID09PSBcIl9cIiB8fFxuICAgICAgICAoXCJhXCIgPD0gY3VycmVudCAmJiBjdXJyZW50IDw9IFwielwiKSB8fFxuICAgICAgICAoXCJBXCIgPD0gY3VycmVudCAmJiBjdXJyZW50IDw9IFwiWlwiKSB8fFxuICAgICAgICAoXCIwXCIgPD0gY3VycmVudCAmJiBjdXJyZW50IDw9IFwiOVwiKVxuICAgICAgKSB7XG4gICAgICAgIGxvb2tBaGVhZCArPSAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbGVuZ3RoID0gbG9va0FoZWFkIC0gaW5kZXg7XG4gICAgY29uc3QgdmFsdWUgPSB0ZXh0LnN1YnN0cihpbmRleCwgbGVuZ3RoKTtcblxuICAgIHN3aXRjaCAodmFsdWUpIHtcbiAgICAgIGNhc2UgXCJ2ZXJzaW9uXCI6IHtcbiAgICAgICAgYWRkVG9rZW4oVG9rZW5LaW5kLlZlcnNpb25LZXl3b3JkLCB2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcIndvcmtmbG93XCI6IHtcbiAgICAgICAgYWRkVG9rZW4oVG9rZW5LaW5kLldvcmtmbG93S2V5d29yZCwgdmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJhY3Rpb25cIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuQWN0aW9uS2V5d29yZCwgdmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJvblwiOiB7XG4gICAgICAgIGFkZFRva2VuKFRva2VuS2luZC5PbktleXdvcmQsIHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwicmVzb2x2ZXNcIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuUmVzb2x2ZXNLZXl3b3JkLCB2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcInVzZXNcIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuVXNlc0tleXdvcmQsIHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwibmVlZHNcIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuTmVlZHNLZXl3b3JkLCB2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcInJ1bnNcIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuUnVuc0tleXdvcmQsIHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwiYXJnc1wiOiB7XG4gICAgICAgIGFkZFRva2VuKFRva2VuS2luZC5BcmdzS2V5d29yZCwgdmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJlbnZcIjoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuRW52S2V5d29yZCwgdmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgXCJzZWNyZXRzXCI6IHtcbiAgICAgICAgYWRkVG9rZW4oVG9rZW5LaW5kLlNlY3JldHNLZXl3b3JkLCB2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICBhZGRUb2tlbihUb2tlbktpbmQuSWRlbnRpZmllciwgdmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBhZGRUb2tlbihraW5kOiBUb2tlbktpbmQsIGNvbnRlbnRzOiBzdHJpbmcpOiBUb2tlbiB7XG4gICAgY29uc3QgdG9rZW4gPSB7XG4gICAgICBraW5kLFxuICAgICAgdGV4dDogY29udGVudHMsXG4gICAgICByYW5nZTogZ2V0UmFuZ2UoY2hhcmFjdGVyLCBjb250ZW50cy5sZW5ndGgpLFxuICAgIH07XG5cbiAgICBpbmRleCArPSBjb250ZW50cy5sZW5ndGg7XG4gICAgY2hhcmFjdGVyICs9IGNvbnRlbnRzLmxlbmd0aDtcblxuICAgIHRva2Vucy5wdXNoKHRva2VuKTtcbiAgICByZXR1cm4gdG9rZW47XG4gIH1cblxuICBmdW5jdGlvbiBnZXRSYW5nZShjaGFyYWN0ZXI6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIpOiBSYW5nZSB7XG4gICAgcmV0dXJuIFJhbmdlLmNyZWF0ZShsaW5lLCBjaGFyYWN0ZXIsIGxpbmUsIGNoYXJhY3RlciArIGxlbmd0aCk7XG4gIH1cbn1cbiJdfQ==
