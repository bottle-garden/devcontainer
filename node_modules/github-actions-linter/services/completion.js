"use strict";
/*!
 * Copyright 2019 Omar Tawfik. Please see LICENSE file at the root of this repository.
 */
var __values = (this && this.__values) || function (o) {
    var m = typeof Symbol === "function" && o[Symbol.iterator], i = 0;
    if (m) return m.call(o);
    return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
Object.defineProperty(exports, "__esModule", { value: true });
var vscode_languageserver_1 = require("vscode-languageserver");
var cache_1 = require("../util/cache");
var ranges_1 = require("../util/ranges");
var tokens_1 = require("../scanning/tokens");
var webhooks = require("@octokit/webhooks-definitions");
var syntax_nodes_1 = require("../parsing/syntax-nodes");
var CompletionService = /** @class */ (function () {
    function CompletionService() {
    }
    CompletionService.prototype.fillCapabilities = function (capabilities) {
        capabilities.completionProvider = {
            triggerCharacters: ['"'],
        };
    };
    CompletionService.prototype.activate = function (connection, documents) {
        connection.onCompletion(function (params) {
            var uri = params.textDocument.uri;
            var compilation = cache_1.accessCache(documents, uri);
            return CompletionService.provideCompletion(compilation, params.position);
        });
    };
    CompletionService.provideCompletion = function (compilation, position) {
        var e_1, _a, e_2, _b;
        try {
            for (var _c = __values(compilation.syntax.blocks), _d = _c.next(); !_d.done; _d = _c.next()) {
                var block = _d.value;
                if (ranges_1.rangeContains(block.range, position)) {
                    try {
                        for (var _e = __values(block.properties), _f = _e.next(); !_f.done; _f = _e.next()) {
                            var property = _f.value;
                            if (ranges_1.rangeContains(property.range, position)) {
                                switch (property.key.kind) {
                                    case tokens_1.TokenKind.ResolvesKeyword:
                                    case tokens_1.TokenKind.NeedsKeyword: {
                                        return provideActions(compilation, property, position);
                                    }
                                    case tokens_1.TokenKind.OnKeyword: {
                                        return provideEvents(property, position);
                                    }
                                    default: {
                                        return [];
                                    }
                                }
                            }
                        }
                    }
                    catch (e_2_1) { e_2 = { error: e_2_1 }; }
                    finally {
                        try {
                            if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
                        }
                        finally { if (e_2) throw e_2.error; }
                    }
                    return provideProperties(block);
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return [];
    };
    return CompletionService;
}());
exports.CompletionService = CompletionService;
function provideEvents(property, position) {
    if (!isInsideString(property, position)) {
        return [];
    }
    return webhooks.map(function (webhook) {
        return {
            label: webhook.name,
            kind: vscode_languageserver_1.CompletionItemKind.Event,
            detail: "Insert the event '" + webhook.name + "'.",
        };
    });
}
function provideActions(compilation, property, position) {
    if (!isInsideString(property, position)) {
        return [];
    }
    return Array.apply(void 0, __spread(compilation.actions.keys())).map(function (action) {
        return {
            label: action,
            kind: vscode_languageserver_1.CompletionItemKind.Class,
            detail: "Insert the action '" + action + "'.",
        };
    });
}
function provideProperties(block) {
    var kinds;
    switch (block.type.kind) {
        case tokens_1.TokenKind.WorkflowKeyword: {
            kinds = [tokens_1.TokenKind.OnKeyword, tokens_1.TokenKind.ResolvesKeyword];
            break;
        }
        case tokens_1.TokenKind.ActionKeyword: {
            kinds = [
                tokens_1.TokenKind.UsesKeyword,
                tokens_1.TokenKind.NeedsKeyword,
                tokens_1.TokenKind.RunsKeyword,
                tokens_1.TokenKind.ArgsKeyword,
                tokens_1.TokenKind.EnvKeyword,
                tokens_1.TokenKind.SecretsKeyword,
            ];
            break;
        }
        default: {
            throw new Error("Unexpected token kind '" + block.type.kind + "'");
        }
    }
    return kinds.map(function (kind) {
        var text = tokens_1.getTokenDescription(kind);
        return {
            label: text,
            kind: vscode_languageserver_1.CompletionItemKind.Property,
            detail: "Insert a new '" + text + "' property.",
        };
    });
}
function isInsideString(property, position) {
    switch (property.kind) {
        case syntax_nodes_1.SyntaxKind.ArrayProperty: {
            return property.items.some(function (item) { return ranges_1.rangeContains(item.value.range, position); });
        }
        case syntax_nodes_1.SyntaxKind.StringProperty: {
            var value = property.value;
            return value ? ranges_1.rangeContains(value.range, position) : false;
        }
        case syntax_nodes_1.SyntaxKind.ObjectMember: {
            return false;
        }
        default: {
            throw new Error("Unexpected syntax kind '" + property.kind + "'");
        }
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zZXJ2aWNlcy9jb21wbGV0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCwrREFPK0I7QUFFL0IsdUNBQTRDO0FBRTVDLHlDQUErQztBQUMvQyw2Q0FBb0U7QUFDcEUsd0RBQTBEO0FBQzFELHdEQU1pQztBQUVqQztJQUFBO0lBeUNBLENBQUM7SUF4Q1EsNENBQWdCLEdBQXZCLFVBQXdCLFlBQWdDO1FBQ3RELFlBQVksQ0FBQyxrQkFBa0IsR0FBRztZQUNoQyxpQkFBaUIsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUN6QixDQUFDO0lBQ0osQ0FBQztJQUVNLG9DQUFRLEdBQWYsVUFBZ0IsVUFBdUIsRUFBRSxTQUF3QjtRQUMvRCxVQUFVLENBQUMsWUFBWSxDQUFDLFVBQUEsTUFBTTtZQUNwQixJQUFBLDZCQUFHLENBQXlCO1lBQ3BDLElBQU0sV0FBVyxHQUFHLG1CQUFXLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ2hELE9BQU8saUJBQWlCLENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFYSxtQ0FBaUIsR0FBL0IsVUFBZ0MsV0FBd0IsRUFBRSxRQUFrQjs7O1lBQzFFLEtBQW9CLElBQUEsS0FBQSxTQUFBLFdBQVcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFBLGdCQUFBLDRCQUFFO2dCQUExQyxJQUFNLEtBQUssV0FBQTtnQkFDZCxJQUFJLHNCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsRUFBRTs7d0JBQ3hDLEtBQXVCLElBQUEsS0FBQSxTQUFBLEtBQUssQ0FBQyxVQUFVLENBQUEsZ0JBQUEsNEJBQUU7NEJBQXBDLElBQU0sUUFBUSxXQUFBOzRCQUNqQixJQUFJLHNCQUFhLENBQUMsUUFBUSxDQUFDLEtBQUss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WCxJQUFJLEVBQUUsMENBQWtCLENBQUMsUUFBUTtZQUNqQyxNQUFNLEVBQUUsbUJBQWlCLElBQUksZ0JBQWE7U0FDM0MsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLFFBQTRCLEVBQUUsUUFBa0I7SUFDdEUsUUFBUSxRQUFRLENBQUMsSUFBSSxFQUFFO1FBQ3JCLEtBQUsseUJBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUM3QixPQUFRLFFBQWdDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLHNCQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEVBQXpDLENBQXlDLENBQUMsQ0FBQztTQUN4RztRQUNELEtBQUsseUJBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUM5QixJQUFNLEtBQUssR0FBSSxRQUFpQyxDQUFDLEtBQUssQ0FBQztZQUN2RCxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsc0JBQWEsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDN0Q7UUFDRCxLQUFLLHlCQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDNUIsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELE9BQU8sQ0FBQyxDQUFDO1lBQ1AsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBMkIsUUFBUSxDQUFDLElBQUksTUFBRyxDQUFDLENBQUM7U0FDOUQ7S0FDRjtBQUNILENBQUMiLCJmaWxlIjoic3JjL3NlcnZpY2VzL2NvbXBsZXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAyMDE5IE9tYXIgVGF3ZmlrLiBQbGVhc2Ugc2VlIExJQ0VOU0UgZmlsZSBhdCB0aGUgcm9vdCBvZiB0aGlzIHJlcG9zaXRvcnkuXG4gKi9cblxuaW1wb3J0IHtcbiAgSUNvbm5lY3Rpb24sXG4gIFRleHREb2N1bWVudHMsXG4gIFNlcnZlckNhcGFiaWxpdGllcyxcbiAgQ29tcGxldGlvbkl0ZW0sXG4gIFBvc2l0aW9uLFxuICBDb21wbGV0aW9uSXRlbUtpbmQsXG59IGZyb20gXCJ2c2NvZGUtbGFuZ3VhZ2VzZXJ2ZXJcIjtcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2ZXJcIjtcbmltcG9ydCB7IGFjY2Vzc0NhY2hlIH0gZnJvbSBcIi4uL3V0aWwvY2FjaGVcIjtcbmltcG9ydCB7IENvbXBpbGF0aW9uIH0gZnJvbSBcIi4uL3V0aWwvY29tcGlsYXRpb25cIjtcbmltcG9ydCB7IHJhbmdlQ29udGFpbnMgfSBmcm9tIFwiLi4vdXRpbC9yYW5nZXNcIjtcbmltcG9ydCB7IFRva2VuS2luZCwgZ2V0VG9rZW5EZXNjcmlwdGlvbiB9IGZyb20gXCIuLi9zY2FubmluZy90b2tlbnNcIjtcbmltcG9ydCAqIGFzIHdlYmhvb2tzIGZyb20gXCJAb2N0b2tpdC93ZWJob29rcy1kZWZpbml0aW9uc1wiO1xuaW1wb3J0IHtcbiAgU3ludGF4S2luZCxcbiAgQXJyYXlQcm9wZXJ0eVN5bnRheCxcbiAgU3RyaW5nUHJvcGVydHlTeW50YXgsXG4gIEJhc2VQcm9wZXJ0eVN5bnRheCxcbiAgQmxvY2tTeW50YXgsXG59IGZyb20gXCIuLi9wYXJzaW5nL3N5bnRheC1ub2Rlc1wiO1xuXG5leHBvcnQgY2xhc3MgQ29tcGxldGlvblNlcnZpY2UgaW1wbGVtZW50cyBMYW5ndWFnZVNlcnZpY2Uge1xuICBwdWJsaWMgZmlsbENhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IHZvaWQge1xuICAgIGNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIgPSB7XG4gICAgICB0cmlnZ2VyQ2hhcmFjdGVyczogWydcIiddLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGUoY29ubmVjdGlvbjogSUNvbm5lY3Rpb24sIGRvY3VtZW50czogVGV4dERvY3VtZW50cyk6IHZvaWQge1xuICAgIGNvbm5lY3Rpb24ub25Db21wbGV0aW9uKHBhcmFtcyA9PiB7XG4gICAgICBjb25zdCB7IHVyaSB9ID0gcGFyYW1zLnRleHREb2N1bWVudDtcbiAgICAgIGNvbnN0IGNvbXBpbGF0aW9uID0gYWNjZXNzQ2FjaGUoZG9jdW1lbnRzLCB1cmkpO1xuICAgICAgcmV0dXJuIENvbXBsZXRpb25TZXJ2aWNlLnByb3ZpZGVDb21wbGV0aW9uKGNvbXBpbGF0aW9uLCBwYXJhbXMucG9zaXRpb24pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBwcm92aWRlQ29tcGxldGlvbihjb21waWxhdGlvbjogQ29tcGlsYXRpb24sIHBvc2l0aW9uOiBQb3NpdGlvbik6IENvbXBsZXRpb25JdGVtW10ge1xuICAgIGZvciAoY29uc3QgYmxvY2sgb2YgY29tcGlsYXRpb24uc3ludGF4LmJsb2Nrcykge1xuICAgICAgaWYgKHJhbmdlQ29udGFpbnMoYmxvY2sucmFuZ2UsIHBvc2l0aW9uKSkge1xuICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIGJsb2NrLnByb3BlcnRpZXMpIHtcbiAgICAgICAgICBpZiAocmFuZ2VDb250YWlucyhwcm9wZXJ0eS5yYW5nZSwgcG9zaXRpb24pKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKHByb3BlcnR5LmtleS5raW5kKSB7XG4gICAgICAgICAgICAgIGNhc2UgVG9rZW5LaW5kLlJlc29sdmVzS2V5d29yZDpcbiAgICAgICAgICAgICAgY2FzZSBUb2tlbktpbmQuTmVlZHNLZXl3b3JkOiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVBY3Rpb25zKGNvbXBpbGF0aW9uLCBwcm9wZXJ0eSwgcG9zaXRpb24pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNhc2UgVG9rZW5LaW5kLk9uS2V5d29yZDoge1xuICAgICAgICAgICAgICAgIHJldHVybiBwcm92aWRlRXZlbnRzKHByb3BlcnR5LCBwb3NpdGlvbik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcm92aWRlUHJvcGVydGllcyhibG9jayk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmZ1bmN0aW9uIHByb3ZpZGVFdmVudHMocHJvcGVydHk6IEJhc2VQcm9wZXJ0eVN5bnRheCwgcG9zaXRpb246IFBvc2l0aW9uKTogQ29tcGxldGlvbkl0ZW1bXSB7XG4gIGlmICghaXNJbnNpZGVTdHJpbmcocHJvcGVydHksIHBvc2l0aW9uKSkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJldHVybiB3ZWJob29rcy5tYXAod2ViaG9vayA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxhYmVsOiB3ZWJob29rLm5hbWUsXG4gICAgICBraW5kOiBDb21wbGV0aW9uSXRlbUtpbmQuRXZlbnQsXG4gICAgICBkZXRhaWw6IGBJbnNlcnQgdGhlIGV2ZW50ICcke3dlYmhvb2submFtZX0nLmAsXG4gICAgfTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHByb3ZpZGVBY3Rpb25zKGNvbXBpbGF0aW9uOiBDb21waWxhdGlvbiwgcHJvcGVydHk6IEJhc2VQcm9wZXJ0eVN5bnRheCwgcG9zaXRpb246IFBvc2l0aW9uKTogQ29tcGxldGlvbkl0ZW1bXSB7XG4gIGlmICghaXNJbnNpZGVTdHJpbmcocHJvcGVydHksIHBvc2l0aW9uKSkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJldHVybiBBcnJheSguLi5jb21waWxhdGlvbi5hY3Rpb25zLmtleXMoKSkubWFwKGFjdGlvbiA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxhYmVsOiBhY3Rpb24sXG4gICAgICBraW5kOiBDb21wbGV0aW9uSXRlbUtpbmQuQ2xhc3MsXG4gICAgICBkZXRhaWw6IGBJbnNlcnQgdGhlIGFjdGlvbiAnJHthY3Rpb259Jy5gLFxuICAgIH07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBwcm92aWRlUHJvcGVydGllcyhibG9jazogQmxvY2tTeW50YXgpOiBDb21wbGV0aW9uSXRlbVtdIHtcbiAgbGV0IGtpbmRzOiBUb2tlbktpbmRbXTtcbiAgc3dpdGNoIChibG9jay50eXBlLmtpbmQpIHtcbiAgICBjYXNlIFRva2VuS2luZC5Xb3JrZmxvd0tleXdvcmQ6IHtcbiAgICAgIGtpbmRzID0gW1Rva2VuS2luZC5PbktleXdvcmQsIFRva2VuS2luZC5SZXNvbHZlc0tleXdvcmRdO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgVG9rZW5LaW5kLkFjdGlvbktleXdvcmQ6IHtcbiAgICAgIGtpbmRzID0gW1xuICAgICAgICBUb2tlbktpbmQuVXNlc0tleXdvcmQsXG4gICAgICAgIFRva2VuS2luZC5OZWVkc0tleXdvcmQsXG4gICAgICAgIFRva2VuS2luZC5SdW5zS2V5d29yZCxcbiAgICAgICAgVG9rZW5LaW5kLkFyZ3NLZXl3b3JkLFxuICAgICAgICBUb2tlbktpbmQuRW52S2V5d29yZCxcbiAgICAgICAgVG9rZW5LaW5kLlNlY3JldHNLZXl3b3JkLFxuICAgICAgXTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBkZWZhdWx0OiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdG9rZW4ga2luZCAnJHtibG9jay50eXBlLmtpbmR9J2ApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBraW5kcy5tYXAoa2luZCA9PiB7XG4gICAgY29uc3QgdGV4dCA9IGdldFRva2VuRGVzY3JpcHRpb24oa2luZCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxhYmVsOiB0ZXh0LFxuICAgICAga2luZDogQ29tcGxldGlvbkl0ZW1LaW5kLlByb3BlcnR5LFxuICAgICAgZGV0YWlsOiBgSW5zZXJ0IGEgbmV3ICcke3RleHR9JyBwcm9wZXJ0eS5gLFxuICAgIH07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpc0luc2lkZVN0cmluZyhwcm9wZXJ0eTogQmFzZVByb3BlcnR5U3ludGF4LCBwb3NpdGlvbjogUG9zaXRpb24pOiBib29sZWFuIHtcbiAgc3dpdGNoIChwcm9wZXJ0eS5raW5kKSB7XG4gICAgY2FzZSBTeW50YXhLaW5kLkFycmF5UHJvcGVydHk6IHtcbiAgICAgIHJldHVybiAocHJvcGVydHkgYXMgQXJyYXlQcm9wZXJ0eVN5bnRheCkuaXRlbXMuc29tZShpdGVtID0+IHJhbmdlQ29udGFpbnMoaXRlbS52YWx1ZS5yYW5nZSwgcG9zaXRpb24pKTtcbiAgICB9XG4gICAgY2FzZSBTeW50YXhLaW5kLlN0cmluZ1Byb3BlcnR5OiB7XG4gICAgICBjb25zdCB2YWx1ZSA9IChwcm9wZXJ0eSBhcyBTdHJpbmdQcm9wZXJ0eVN5bnRheCkudmFsdWU7XG4gICAgICByZXR1cm4gdmFsdWUgPyByYW5nZUNvbnRhaW5zKHZhbHVlLnJhbmdlLCBwb3NpdGlvbikgOiBmYWxzZTtcbiAgICB9XG4gICAgY2FzZSBTeW50YXhLaW5kLk9iamVjdE1lbWJlcjoge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBkZWZhdWx0OiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgc3ludGF4IGtpbmQgJyR7cHJvcGVydHkua2luZH0nYCk7XG4gICAgfVxuICB9XG59XG4iXX0=
