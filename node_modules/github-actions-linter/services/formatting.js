"use strict";
/*!
 * Copyright 2019 Omar Tawfik. Please see LICENSE file at the root of this repository.
 */
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
Object.defineProperty(exports, "__esModule", { value: true });
var vscode_languageserver_1 = require("vscode-languageserver");
var cache_1 = require("../util/cache");
var tokens_1 = require("../scanning/tokens");
var syntax_nodes_1 = require("../parsing/syntax-nodes");
var diagnostics_1 = require("../util/diagnostics");
var PARSE_ERRORS_MESSAGE = "Cannot format document with parsing errors.";
var FormattingService = /** @class */ (function () {
    function FormattingService() {
    }
    FormattingService.prototype.fillCapabilities = function (capabilities) {
        capabilities.documentFormattingProvider = true;
    };
    FormattingService.prototype.activate = function (connection, documents) {
        connection.onDocumentFormatting(function (params) {
            var uri = params.textDocument.uri;
            var compilation = cache_1.accessCache(documents, uri);
            if (compilation.diagnostics.some(function (d) { return d.code < diagnostics_1.DiagnosticCode.PARSING_ERRORS_MARK; })) {
                connection.window.showErrorMessage(PARSE_ERRORS_MESSAGE);
                return [];
            }
            var _a = params.options, insertSpaces = _a.insertSpaces, tabSize = _a.tabSize;
            var indentationValue = insertSpaces ? " ".repeat(tabSize) : "\t";
            var result = FormattingService.format(compilation, indentationValue);
            var fullRange = vscode_languageserver_1.Range.create(0, 0, Number.MAX_SAFE_INTEGER, Number.MAX_SAFE_INTEGER);
            return [vscode_languageserver_1.TextEdit.replace(fullRange, result)];
        });
    };
    FormattingService.format = function (compilation, indentationValue) {
        var lines = Array();
        var indentationLevel = 0;
        var lastTokenAdded;
        var currentLine = "";
        compilation.syntax.commentsAfter.forEach(function (comment) {
            add(comment);
        });
        compilation.syntax.versions.forEach(function (version) {
            add(version.version);
            add(version.equal);
            add(version.integer);
        });
        compilation.syntax.blocks.forEach(function (block) {
            addBlockLikeSyntax({
                firstToken: block.type,
                secondToken: block.name,
                openBracket: block.openBracket,
                addBody: function () { return addProperties(block); },
                closeBracket: block.closeBracket,
            });
        });
        addLineBreak(true);
        addLineBreak(true);
        return lines.join("\n");
        function addProperties(block) {
            var strings = Array();
            var arrays = Array();
            var objects = Array();
            block.properties.forEach(function (property) {
                switch (property.kind) {
                    case syntax_nodes_1.SyntaxKind.StringProperty:
                        strings.push(property);
                        break;
                    case syntax_nodes_1.SyntaxKind.ArrayProperty:
                        arrays.push(property);
                        break;
                    case syntax_nodes_1.SyntaxKind.ObjectProperty:
                        objects.push(property);
                        break;
                    default:
                        throw new Error("Syntax kind '" + property.kind + "' is not supported");
                }
            });
            var longestKeyLength = Math.max.apply(Math, __spread(block.properties.map(function (s) { return s.key.text.length; })));
            strings.forEach(function (property) {
                add(property.key);
                if (!property.key.commentAfter && !property.equal.commentsBefore) {
                    currentLine += " ".repeat(longestKeyLength - property.key.text.length);
                }
                add(property.equal);
                add(property.value);
                addLineBreak();
            });
            arrays.forEach(function (property) {
                addBlockLikeSyntax({
                    longestKeyLength: longestKeyLength,
                    firstToken: property.key,
                    secondToken: property.equal,
                    openBracket: property.openBracket,
                    addBody: function () {
                        return property.items.forEach(function (item) {
                            add(item.value);
                            add(item.comma, false);
                            addLineBreak();
                        });
                    },
                    closeBracket: property.closeBracket,
                });
            });
            objects.forEach(function (property) {
                addBlockLikeSyntax({
                    longestKeyLength: longestKeyLength,
                    firstToken: property.key,
                    secondToken: property.equal,
                    openBracket: property.openBracket,
                    addBody: function () {
                        var longestNameLength = Math.max.apply(Math, __spread(property.members.map(function (member) { return member.name.text.length; })));
                        property.members.forEach(function (member) {
                            add(member.name);
                            if (!member.name.commentAfter && !member.equal.commentsBefore) {
                                currentLine += " ".repeat(longestNameLength - member.name.text.length);
                            }
                            add(member.equal);
                            add(member.value);
                            add(member.comma, false);
                            addLineBreak();
                        });
                    },
                    closeBracket: property.closeBracket,
                });
            });
        }
        function addBlockLikeSyntax(opts) {
            addLineBreak(true);
            add(opts.firstToken);
            if (opts.longestKeyLength && !opts.firstToken.commentAfter && !opts.secondToken.commentsBefore) {
                currentLine += " ".repeat(opts.longestKeyLength - opts.firstToken.text.length);
            }
            indentationLevel += 1;
            add(opts.secondToken);
            add(opts.openBracket);
            addLineBreak();
            opts.addBody();
            addLineBreak();
            indentationLevel -= 1;
            add(opts.closeBracket);
            addLineBreak();
        }
        function addLineBreak(addEmpty) {
            if (addEmpty === void 0) { addEmpty = false; }
            if (currentLine.length === 0) {
                if (!addEmpty || lines.length === 0 || lines[lines.length - 1].length === 0) {
                    return;
                }
                if (lastTokenAdded) {
                    switch (lastTokenAdded.kind) {
                        case tokens_1.TokenKind.Comment:
                        case tokens_1.TokenKind.LeftCurlyBracket:
                        case tokens_1.TokenKind.LeftSquareBracket:
                            return;
                        default:
                            break;
                    }
                }
            }
            lines.push(currentLine);
            currentLine = "";
        }
        function add(token, addSpace) {
            if (addSpace === void 0) { addSpace = true; }
            if (!token) {
                return;
            }
            if (token.kind === tokens_1.TokenKind.Missing) {
                throw new Error(PARSE_ERRORS_MESSAGE);
            }
            if (token.commentsBefore) {
                token.commentsBefore.forEach(function (comment) {
                    add(comment);
                    addLineBreak();
                });
            }
            if (currentLine.length === 0) {
                currentLine = indentationValue.repeat(indentationLevel);
            }
            else if (addSpace) {
                currentLine += " ";
            }
            currentLine += token.text;
            lastTokenAdded = token;
            if (token.commentAfter) {
                add(token.commentAfter);
                addLineBreak();
            }
        }
    };
    return FormattingService;
}());
exports.FormattingService = FormattingService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zZXJ2aWNlcy9mb3JtYXR0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILCtEQUF3RztBQUV4Ryx1Q0FBNEM7QUFFNUMsNkNBQXVFO0FBQ3ZFLHdEQU1pQztBQUNqQyxtREFBcUQ7QUFFckQsSUFBTSxvQkFBb0IsR0FBRyw2Q0FBNkMsQ0FBQztBQUUzRTtJQUFBO0lBc05BLENBQUM7SUFyTlEsNENBQWdCLEdBQXZCLFVBQXdCLFlBQWdDO1FBQ3RELFlBQVksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLENBQUM7SUFDakQsQ0FBQztJQUVNLG9DQUFRLEdBQWYsVUFBZ0IsVUFBdUIsRUFBRSxTQUF3QjtRQUMvRCxVQUFVLENBQUMsb0JBQW9CLENBQUMsVUFBQSxNQUFNO1lBQzVCLElBQUEsNkJBQUcsQ0FBeUI7WUFDcEMsSUFBTSxXQUFXLEdBQUcsbUJBQVcsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFaEQsSUFBSSxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFDLENBQUMsQ0FBQyxJQUFlLEdBQUcsNEJBQWMsQ0FBQyxtQkFBbUIsRUFBdkQsQ0FBdUQsQ0FBQyxFQUFFO2dCQUM5RixVQUFVLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLENBQUM7Z0JBQ3pELE9BQU8sRUFBRSxDQUFDO2FBQ1g7WUFFSyxJQUFBLG1CQUEwQyxFQUF4Qyw4QkFBWSxFQUFFLG9CQUEwQixDQUFDO1lBQ2pELElBQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFFbkUsSUFBTSxNQUFNLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3ZFLElBQU0sU0FB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c291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgMjAxOSBPbWFyIFRhd2Zpay4gUGxlYXNlIHNlZSBMSUNFTlNFIGZpbGUgYXQgdGhlIHJvb3Qgb2YgdGhpcyByZXBvc2l0b3J5LlxuICovXG5cbmltcG9ydCB7IElDb25uZWN0aW9uLCBUZXh0RG9jdW1lbnRzLCBTZXJ2ZXJDYXBhYmlsaXRpZXMsIFRleHRFZGl0LCBSYW5nZSB9IGZyb20gXCJ2c2NvZGUtbGFuZ3VhZ2VzZXJ2ZXJcIjtcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2ZXJcIjtcbmltcG9ydCB7IGFjY2Vzc0NhY2hlIH0gZnJvbSBcIi4uL3V0aWwvY2FjaGVcIjtcbmltcG9ydCB7IENvbXBpbGF0aW9uIH0gZnJvbSBcIi4uL3V0aWwvY29tcGlsYXRpb25cIjtcbmltcG9ydCB7IFRva2VuV2l0aFRyaXZpYSwgVG9rZW4sIFRva2VuS2luZCB9IGZyb20gXCIuLi9zY2FubmluZy90b2tlbnNcIjtcbmltcG9ydCB7XG4gIEJsb2NrU3ludGF4LFxuICBTdHJpbmdQcm9wZXJ0eVN5bnRheCxcbiAgQXJyYXlQcm9wZXJ0eVN5bnRheCxcbiAgT2JqZWN0UHJvcGVydHlTeW50YXgsXG4gIFN5bnRheEtpbmQsXG59IGZyb20gXCIuLi9wYXJzaW5nL3N5bnRheC1ub2Rlc1wiO1xuaW1wb3J0IHsgRGlhZ25vc3RpY0NvZGUgfSBmcm9tIFwiLi4vdXRpbC9kaWFnbm9zdGljc1wiO1xuXG5jb25zdCBQQVJTRV9FUlJPUlNfTUVTU0FHRSA9IFwiQ2Fubm90IGZvcm1hdCBkb2N1bWVudCB3aXRoIHBhcnNpbmcgZXJyb3JzLlwiO1xuXG5leHBvcnQgY2xhc3MgRm9ybWF0dGluZ1NlcnZpY2UgaW1wbGVtZW50cyBMYW5ndWFnZVNlcnZpY2Uge1xuICBwdWJsaWMgZmlsbENhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IHZvaWQge1xuICAgIGNhcGFiaWxpdGllcy5kb2N1bWVudEZvcm1hdHRpbmdQcm92aWRlciA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGUoY29ubmVjdGlvbjogSUNvbm5lY3Rpb24sIGRvY3VtZW50czogVGV4dERvY3VtZW50cyk6IHZvaWQge1xuICAgIGNvbm5lY3Rpb24ub25Eb2N1bWVudEZvcm1hdHRpbmcocGFyYW1zID0+IHtcbiAgICAgIGNvbnN0IHsgdXJpIH0gPSBwYXJhbXMudGV4dERvY3VtZW50O1xuICAgICAgY29uc3QgY29tcGlsYXRpb24gPSBhY2Nlc3NDYWNoZShkb2N1bWVudHMsIHVyaSk7XG5cbiAgICAgIGlmIChjb21waWxhdGlvbi5kaWFnbm9zdGljcy5zb21lKGQgPT4gKGQuY29kZSBhcyBudW1iZXIpIDwgRGlhZ25vc3RpY0NvZGUuUEFSU0lOR19FUlJPUlNfTUFSSykpIHtcbiAgICAgICAgY29ubmVjdGlvbi53aW5kb3cuc2hvd0Vycm9yTWVzc2FnZShQQVJTRV9FUlJPUlNfTUVTU0FHRSk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBpbnNlcnRTcGFjZXMsIHRhYlNpemUgfSA9IHBhcmFtcy5vcHRpb25zO1xuICAgICAgY29uc3QgaW5kZW50YXRpb25WYWx1ZSA9IGluc2VydFNwYWNlcyA/IFwiIFwiLnJlcGVhdCh0YWJTaXplKSA6IFwiXFx0XCI7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IEZvcm1hdHRpbmdTZXJ2aWNlLmZvcm1hdChjb21waWxhdGlvbiwgaW5kZW50YXRpb25WYWx1ZSk7XG4gICAgICBjb25zdCBmdWxsUmFuZ2UgPSBSYW5nZS5jcmVhdGUoMCwgMCwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKTtcbiAgICAgIHJldHVybiBbVGV4dEVkaXQucmVwbGFjZShmdWxsUmFuZ2UsIHJlc3VsdCldO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBmb3JtYXQoY29tcGlsYXRpb246IENvbXBpbGF0aW9uLCBpbmRlbnRhdGlvblZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGxpbmVzID0gQXJyYXk8c3RyaW5nPigpO1xuICAgIGxldCBpbmRlbnRhdGlvbkxldmVsID0gMDtcbiAgICBsZXQgbGFzdFRva2VuQWRkZWQ6IFRva2VuIHwgdW5kZWZpbmVkO1xuICAgIGxldCBjdXJyZW50TGluZSA9IFwiXCI7XG5cbiAgICBjb21waWxhdGlvbi5zeW50YXguY29tbWVudHNBZnRlci5mb3JFYWNoKGNvbW1lbnQgPT4ge1xuICAgICAgYWRkKGNvbW1lbnQpO1xuICAgIH0pO1xuXG4gICAgY29tcGlsYXRpb24uc3ludGF4LnZlcnNpb25zLmZvckVhY2godmVyc2lvbiA9PiB7XG4gICAgICBhZGQodmVyc2lvbi52ZXJzaW9uKTtcbiAgICAgIGFkZCh2ZXJzaW9uLmVxdWFsKTtcbiAgICAgIGFkZCh2ZXJzaW9uLmludGVnZXIpO1xuICAgIH0pO1xuXG4gICAgY29tcGlsYXRpb24uc3ludGF4LmJsb2Nrcy5mb3JFYWNoKGJsb2NrID0+IHtcbiAgICAgIGFkZEJsb2NrTGlrZVN5bnRheCh7XG4gICAgICAgIGZpcnN0VG9rZW46IGJsb2NrLnR5cGUsXG4gICAgICAgIHNlY29uZFRva2VuOiBibG9jay5uYW1lLFxuICAgICAgICBvcGVuQnJhY2tldDogYmxvY2sub3BlbkJyYWNrZXQsXG4gICAgICAgIGFkZEJvZHk6ICgpID0+IGFkZFByb3BlcnRpZXMoYmxvY2spLFxuICAgICAgICBjbG9zZUJyYWNrZXQ6IGJsb2NrLmNsb3NlQnJhY2tldCxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgYWRkTGluZUJyZWFrKHRydWUpO1xuICAgIGFkZExpbmVCcmVhayh0cnVlKTtcbiAgICByZXR1cm4gbGluZXMuam9pbihcIlxcblwiKTtcblxuICAgIGZ1bmN0aW9uIGFkZFByb3BlcnRpZXMoYmxvY2s6IEJsb2NrU3ludGF4KTogdm9pZCB7XG4gICAgICBjb25zdCBzdHJpbmdzID0gQXJyYXk8U3RyaW5nUHJvcGVydHlTeW50YXg+KCk7XG4gICAgICBjb25zdCBhcnJheXMgPSBBcnJheTxBcnJheVByb3BlcnR5U3ludGF4PigpO1xuICAgICAgY29uc3Qgb2JqZWN0cyA9IEFycmF5PE9iamVjdFByb3BlcnR5U3ludGF4PigpO1xuXG4gICAgICBibG9jay5wcm9wZXJ0aWVzLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgICBzd2l0Y2ggKHByb3BlcnR5LmtpbmQpIHtcbiAgICAgICAgICBjYXNlIFN5bnRheEtpbmQuU3RyaW5nUHJvcGVydHk6XG4gICAgICAgICAgICBzdHJpbmdzLnB1c2gocHJvcGVydHkgYXMgU3RyaW5nUHJvcGVydHlTeW50YXgpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBTeW50YXhLaW5kLkFycmF5UHJvcGVydHk6XG4gICAgICAgICAgICBhcnJheXMucHVzaChwcm9wZXJ0eSBhcyBBcnJheVByb3BlcnR5U3ludGF4KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgU3ludGF4S2luZC5PYmplY3RQcm9wZXJ0eTpcbiAgICAgICAgICAgIG9iamVjdHMucHVzaChwcm9wZXJ0eSBhcyBPYmplY3RQcm9wZXJ0eVN5bnRheCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTeW50YXgga2luZCAnJHtwcm9wZXJ0eS5raW5kfScgaXMgbm90IHN1cHBvcnRlZGApO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgbG9uZ2VzdEtleUxlbmd0aCA9IE1hdGgubWF4KC4uLmJsb2NrLnByb3BlcnRpZXMubWFwKHMgPT4gcy5rZXkudGV4dC5sZW5ndGgpKTtcblxuICAgICAgc3RyaW5ncy5mb3JFYWNoKHByb3BlcnR5ID0+IHtcbiAgICAgICAgYWRkKHByb3BlcnR5LmtleSk7XG5cbiAgICAgICAgaWYgKCFwcm9wZXJ0eS5rZXkuY29tbWVudEFmdGVyICYmICFwcm9wZXJ0eS5lcXVhbC5jb21tZW50c0JlZm9yZSkge1xuICAgICAgICAgIGN1cnJlbnRMaW5lICs9IFwiIFwiLnJlcGVhdChsb25nZXN0S2V5TGVuZ3RoIC0gcHJvcGVydHkua2V5LnRleHQubGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFkZChwcm9wZXJ0eS5lcXVhbCk7XG4gICAgICAgIGFkZChwcm9wZXJ0eS52YWx1ZSk7XG4gICAgICAgIGFkZExpbmVCcmVhaygpO1xuICAgICAgfSk7XG5cbiAgICAgIGFycmF5cy5mb3JFYWNoKHByb3BlcnR5ID0+IHtcbiAgICAgICAgYWRkQmxvY2tMaWtlU3ludGF4KHtcbiAgICAgICAgICBsb25nZXN0S2V5TGVuZ3RoLFxuICAgICAgICAgIGZpcnN0VG9rZW46IHByb3BlcnR5LmtleSxcbiAgICAgICAgICBzZWNvbmRUb2tlbjogcHJvcGVydHkuZXF1YWwsXG4gICAgICAgICAgb3BlbkJyYWNrZXQ6IHByb3BlcnR5Lm9wZW5CcmFja2V0LFxuICAgICAgICAgIGFkZEJvZHk6ICgpID0+XG4gICAgICAgICAgICBwcm9wZXJ0eS5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgICBhZGQoaXRlbS52YWx1ZSk7XG4gICAgICAgICAgICAgIGFkZChpdGVtLmNvbW1hLCBmYWxzZSk7XG4gICAgICAgICAgICAgIGFkZExpbmVCcmVhaygpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgY2xvc2VCcmFja2V0OiBwcm9wZXJ0eS5jbG9zZUJyYWNrZXQsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIG9iamVjdHMuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG4gICAgICAgIGFkZEJsb2NrTGlrZVN5bnRheCh7XG4gICAgICAgICAgbG9uZ2VzdEtleUxlbmd0aCxcbiAgICAgICAgICBmaXJzdFRva2VuOiBwcm9wZXJ0eS5rZXksXG4gICAgICAgICAgc2Vjb25kVG9rZW46IHByb3BlcnR5LmVxdWFsLFxuICAgICAgICAgIG9wZW5CcmFja2V0OiBwcm9wZXJ0eS5vcGVuQnJhY2tldCxcbiAgICAgICAgICBhZGRCb2R5OiAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsb25nZXN0TmFtZUxlbmd0aCA9IE1hdGgubWF4KC4uLnByb3BlcnR5Lm1lbWJlcnMubWFwKG1lbWJlciA9PiBtZW1iZXIubmFtZS50ZXh0Lmxlbmd0aCkpO1xuICAgICAgICAgICAgcHJvcGVydHkubWVtYmVycy5mb3JFYWNoKG1lbWJlciA9PiB7XG4gICAgICAgICAgICAgIGFkZChtZW1iZXIubmFtZSk7XG5cbiAgICAgICAgICAgICAgaWYgKCFtZW1iZXIubmFtZS5jb21tZW50QWZ0ZXIgJiYgIW1lbWJlci5lcXVhbC5jb21tZW50c0JlZm9yZSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRMaW5lICs9IFwiIFwiLnJlcGVhdChsb25nZXN0TmFtZUxlbmd0aCAtIG1lbWJlci5uYW1lLnRleHQubGVuZ3RoKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGFkZChtZW1iZXIuZXF1YWwpO1xuICAgICAgICAgICAgICBhZGQobWVtYmVyLnZhbHVlKTtcbiAgICAgICAgICAgICAgYWRkKG1lbWJlci5jb21tYSwgZmFsc2UpO1xuICAgICAgICAgICAgICBhZGRMaW5lQnJlYWsoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgY2xvc2VCcmFja2V0OiBwcm9wZXJ0eS5jbG9zZUJyYWNrZXQsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gYWRkQmxvY2tMaWtlU3ludGF4KG9wdHM6IHtcbiAgICAgIHJlYWRvbmx5IGxvbmdlc3RLZXlMZW5ndGg/OiBudW1iZXI7XG4gICAgICByZWFkb25seSBmaXJzdFRva2VuOiBUb2tlbldpdGhUcml2aWE7XG4gICAgICByZWFkb25seSBzZWNvbmRUb2tlbjogVG9rZW5XaXRoVHJpdmlhO1xuICAgICAgcmVhZG9ubHkgb3BlbkJyYWNrZXQ6IFRva2VuV2l0aFRyaXZpYTtcbiAgICAgIHJlYWRvbmx5IGFkZEJvZHk6IEZ1bmN0aW9uO1xuICAgICAgcmVhZG9ubHkgY2xvc2VCcmFja2V0OiBUb2tlbldpdGhUcml2aWE7XG4gICAgfSk6IHZvaWQge1xuICAgICAgYWRkTGluZUJyZWFrKHRydWUpO1xuXG4gICAgICBhZGQob3B0cy5maXJzdFRva2VuKTtcblxuICAgICAgaWYgKG9wdHMubG9uZ2VzdEtleUxlbmd0aCAmJiAhb3B0cy5maXJzdFRva2VuLmNvbW1lbnRBZnRlciAmJiAhb3B0cy5zZWNvbmRUb2tlbi5jb21tZW50c0JlZm9yZSkge1xuICAgICAgICBjdXJyZW50TGluZSArPSBcIiBcIi5yZXBlYXQob3B0cy5sb25nZXN0S2V5TGVuZ3RoIC0gb3B0cy5maXJzdFRva2VuLnRleHQubGVuZ3RoKTtcbiAgICAgIH1cblxuICAgICAgaW5kZW50YXRpb25MZXZlbCArPSAxO1xuXG4gICAgICBhZGQob3B0cy5zZWNvbmRUb2tlbik7XG4gICAgICBhZGQob3B0cy5vcGVuQnJhY2tldCk7XG4gICAgICBhZGRMaW5lQnJlYWsoKTtcblxuICAgICAgb3B0cy5hZGRCb2R5KCk7XG4gICAgICBhZGRMaW5lQnJlYWsoKTtcblxuICAgICAgaW5kZW50YXRpb25MZXZlbCAtPSAxO1xuICAgICAgYWRkKG9wdHMuY2xvc2VCcmFja2V0KTtcbiAgICAgIGFkZExpbmVCcmVhaygpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGFkZExpbmVCcmVhayhhZGRFbXB0eTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XG4gICAgICBpZiAoY3VycmVudExpbmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGlmICghYWRkRW1wdHkgfHwgbGluZXMubGVuZ3RoID09PSAwIHx8IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChsYXN0VG9rZW5BZGRlZCkge1xuICAgICAgICAgIHN3aXRjaCAobGFzdFRva2VuQWRkZWQua2luZCkge1xuICAgICAgICAgICAgY2FzZSBUb2tlbktpbmQuQ29tbWVudDpcbiAgICAgICAgICAgIGNhc2UgVG9rZW5LaW5kLkxlZnRDdXJseUJyYWNrZXQ6XG4gICAgICAgICAgICBjYXNlIFRva2VuS2luZC5MZWZ0U3F1YXJlQnJhY2tldDpcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGxpbmVzLnB1c2goY3VycmVudExpbmUpO1xuICAgICAgY3VycmVudExpbmUgPSBcIlwiO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGFkZCh0b2tlbjogVG9rZW5XaXRoVHJpdmlhIHwgdW5kZWZpbmVkLCBhZGRTcGFjZTogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAodG9rZW4ua2luZCA9PT0gVG9rZW5LaW5kLk1pc3NpbmcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFBBUlNFX0VSUk9SU19NRVNTQUdFKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRva2VuLmNvbW1lbnRzQmVmb3JlKSB7XG4gICAgICAgIHRva2VuLmNvbW1lbnRzQmVmb3JlLmZvckVhY2goY29tbWVudCA9PiB7XG4gICAgICAgICAgYWRkKGNvbW1lbnQpO1xuICAgICAgICAgIGFkZExpbmVCcmVhaygpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGN1cnJlbnRMaW5lLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjdXJyZW50TGluZSA9IGluZGVudGF0aW9uVmFsdWUucmVwZWF0KGluZGVudGF0aW9uTGV2ZWwpO1xuICAgICAgfSBlbHNlIGlmIChhZGRTcGFjZSkge1xuICAgICAgICBjdXJyZW50TGluZSArPSBcIiBcIjtcbiAgICAgIH1cblxuICAgICAgY3VycmVudExpbmUgKz0gdG9rZW4udGV4dDtcbiAgICAgIGxhc3RUb2tlbkFkZGVkID0gdG9rZW47XG5cbiAgICAgIGlmICh0b2tlbi5jb21tZW50QWZ0ZXIpIHtcbiAgICAgICAgYWRkKHRva2VuLmNvbW1lbnRBZnRlcik7XG4gICAgICAgIGFkZExpbmVCcmVhaygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19
