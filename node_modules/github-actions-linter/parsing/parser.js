"use strict";
/*!
 * Copyright 2019 Omar Tawfik. Please see LICENSE file at the root of this repository.
 */
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
Object.defineProperty(exports, "__esModule", { value: true });
var tokens_1 = require("../scanning/tokens");
var syntax_nodes_1 = require("./syntax-nodes");
function parseTokens(allTokens, bag) {
    var tokens = allTokens.filter(function (token) { return token.kind !== tokens_1.TokenKind.Unrecognized; });
    var commentsAfter = extractCommentsAtEndOfFile();
    var reportedErrors = Array();
    var index = 0;
    var versions = Array();
    var blocks = Array();
    while (index < tokens.length) {
        parseTopLevelNode({
            supported: [],
        });
    }
    return new syntax_nodes_1.DocumentSyntax(versions, blocks, commentsAfter);
    function extractCommentsAtEndOfFile() {
        var end = tokens.length - 1;
        while (end >= 0 && tokens[end].kind === tokens_1.TokenKind.Comment) {
            end -= 1;
        }
        var result = tokens.slice(end + 1);
        tokens.splice(end + 1);
        return result;
    }
    function parseTopLevelNode(context) {
        var keywordKinds = [tokens_1.TokenKind.VersionKeyword, tokens_1.TokenKind.WorkflowKeyword, tokens_1.TokenKind.ActionKeyword];
        var keyword = eat.apply(void 0, __spread([context], keywordKinds));
        var innerContext = {
            parent: context,
            supported: keywordKinds,
        };
        switch (keyword.kind) {
            case tokens_1.TokenKind.VersionKeyword: {
                parseVersion(keyword, innerContext);
                break;
            }
            case tokens_1.TokenKind.WorkflowKeyword:
            case tokens_1.TokenKind.ActionKeyword: {
                parseBlock(keyword, innerContext);
                break;
            }
            case tokens_1.TokenKind.Missing: {
                // move to the next token
                break;
            }
            default: {
                throw new Error("Unexpected token '" + tokens_1.getTokenDescription(keyword.kind) + "' here.");
            }
        }
    }
    function parseVersion(version, context) {
        var equal = eat(context, tokens_1.TokenKind.Equal);
        var integer = eat(context, tokens_1.TokenKind.IntegerLiteral);
        versions.push(new syntax_nodes_1.VersionSyntax(version, equal, integer));
    }
    function parseBlock(type, context) {
        var name = eat(context, tokens_1.TokenKind.StringLiteral);
        var openBracket = eat(context, tokens_1.TokenKind.LeftCurlyBracket);
        var properties = parseProperties({
            parent: context,
            supported: [tokens_1.TokenKind.RightCurlyBracket],
        });
        var closeBracket = eat(context, tokens_1.TokenKind.RightCurlyBracket);
        blocks.push(new syntax_nodes_1.BlockSyntax(type, name, openBracket, properties, closeBracket));
    }
    function parseProperties(context) {
        var properties = [];
        while (!isNext(tokens_1.TokenKind.RightCurlyBracket)) {
            var keyKinds = [
                tokens_1.TokenKind.OnKeyword,
                tokens_1.TokenKind.ResolvesKeyword,
                tokens_1.TokenKind.UsesKeyword,
                tokens_1.TokenKind.NeedsKeyword,
                tokens_1.TokenKind.RunsKeyword,
                tokens_1.TokenKind.ArgsKeyword,
                tokens_1.TokenKind.EnvKeyword,
                tokens_1.TokenKind.SecretsKeyword,
            ];
            var key = eat.apply(void 0, __spread([context], keyKinds));
            if (key.kind === tokens_1.TokenKind.Missing) {
                // Stop looking for properties
                break;
            }
            properties.push(parseProperty(key, {
                parent: context,
                supported: keyKinds,
            }));
        }
        return properties;
    }
    function parseProperty(key, context) {
        var equal = eat(context, tokens_1.TokenKind.Equal);
        var valueStart = eat(context, tokens_1.TokenKind.StringLiteral, tokens_1.TokenKind.LeftCurlyBracket, tokens_1.TokenKind.LeftSquareBracket);
        var property;
        switch (valueStart.kind) {
            case tokens_1.TokenKind.StringLiteral: {
                property = new syntax_nodes_1.StringPropertySyntax(key, equal, valueStart);
                break;
            }
            case tokens_1.TokenKind.LeftSquareBracket: {
                var items = parseArrayItems(context);
                var closeBracket = eat(context, tokens_1.TokenKind.RightSquareBracket);
                property = new syntax_nodes_1.ArrayPropertySyntax(key, equal, valueStart, items, closeBracket);
                break;
            }
            case tokens_1.TokenKind.LeftCurlyBracket: {
                var members = parseObjectMembers(context);
                var closeBracket = eat(context, tokens_1.TokenKind.RightCurlyBracket);
                property = new syntax_nodes_1.ObjectPropertySyntax(key, equal, valueStart, members, closeBracket);
                break;
            }
            case tokens_1.TokenKind.Missing: {
                // Insert missing value as a string property
                property = new syntax_nodes_1.StringPropertySyntax(key, equal, valueStart);
                break;
            }
            default: {
                throw new Error("Unexpected token '" + tokens_1.getTokenDescription(valueStart.kind) + "' here.");
            }
        }
        return property;
    }
    function parseArrayItems(context) {
        var items = Array();
        while (!isNext(tokens_1.TokenKind.RightSquareBracket)) {
            var value = eat(context, tokens_1.TokenKind.StringLiteral);
            if (value.kind === tokens_1.TokenKind.Missing) {
                break;
            }
            var comma = void 0;
            if (isNext(tokens_1.TokenKind.Comma)) {
                comma = eat(context, tokens_1.TokenKind.Comma);
            }
            items.push(new syntax_nodes_1.ArrayItemSyntax(value, comma));
        }
        return items;
    }
    function parseObjectMembers(context) {
        var members = Array();
        while (!isNext(tokens_1.TokenKind.RightCurlyBracket)) {
            var name = eat(context, tokens_1.TokenKind.Identifier);
            if (name.kind === tokens_1.TokenKind.Missing) {
                break;
            }
            var equal = eat(context, tokens_1.TokenKind.Equal);
            var value = eat(context, tokens_1.TokenKind.StringLiteral);
            var comma = void 0;
            if (isNext(tokens_1.TokenKind.Comma)) {
                comma = eat(context, tokens_1.TokenKind.Comma);
            }
            members.push(new syntax_nodes_1.ObjectMemberSyntax(name, equal, value, comma));
        }
        return members;
    }
    function isNext(kind) {
        return index < tokens.length && tokens[index].kind === kind;
    }
    function eat(context) {
        var expected = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            expected[_i - 1] = arguments[_i];
        }
        var commentsBefore = eatComments();
        while (true) {
            if (index >= tokens.length) {
                return __assign({ commentsBefore: commentsBefore }, missingToken(expected));
            }
            var current = tokens[index];
            if (expected.includes(current.kind)) {
                index += 1;
                if (index < tokens.length) {
                    var commentAfter = tokens[index];
                    if (commentAfter.kind === tokens_1.TokenKind.Comment && commentAfter.range.start.line === current.range.end.line) {
                        index += 1;
                        return __assign({ commentsBefore: commentsBefore }, current, { commentAfter: commentAfter });
                    }
                }
                return __assign({ commentsBefore: commentsBefore }, current);
            }
            var canBeHandledByParent = false;
            var currentContext = context;
            while (!canBeHandledByParent && currentContext) {
                canBeHandledByParent = currentContext.supported.includes(current.kind);
                currentContext = currentContext.parent;
            }
            if (canBeHandledByParent) {
                return __assign({ commentsBefore: commentsBefore }, missingToken(expected));
            }
            if (!reportedErrors[index]) {
                bag.unexpectedToken(current);
                reportedErrors[index] = true;
            }
            index += 1;
        }
    }
    function eatComments() {
        var result;
        while (index < tokens.length && tokens[index].kind === tokens_1.TokenKind.Comment) {
            if (!result) {
                result = [];
            }
            result.push(tokens[index]);
            index += 1;
        }
        return result;
    }
    function missingToken(expected) {
        var missingIndex = index;
        var endOfFile = index >= tokens.length;
        if (endOfFile) {
            missingIndex = tokens.length - 1;
        }
        var range = tokens[missingIndex].range;
        if (!reportedErrors[missingIndex]) {
            bag.missingToken(expected, range, endOfFile);
            reportedErrors[missingIndex] = true;
        }
        return {
            range: range,
            kind: tokens_1.TokenKind.Missing,
            text: "",
        };
    }
}
exports.parseTokens = parseTokens;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsWUFBWSxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDakMsR0FBRyxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzdDLGNBQWMsQ0FBQyxZQUFZLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDckM7UUFFRCxPQUFPO1lBQ0wsS0FBSyxPQUFBO1lBQ0wsSUFBSSxFQUFFLGtCQUFTLENBQUMsT0FBTztZQUN2QixJQUFJLEVBQUUsRUFBRTtTQUNULENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQztBQTNSRCxrQ0EyUkMiLCJmaWxlIjoic3JjL3BhcnNpbmcvcGFyc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgMjAxOSBPbWFyIFRhd2Zpay4gUGxlYXNlIHNlZSBMSUNFTlNFIGZpbGUgYXQgdGhlIHJvb3Qgb2YgdGhpcyByZXBvc2l0b3J5LlxuICovXG5cbmltcG9ydCB7IERpYWdub3N0aWNCYWcgfSBmcm9tIFwiLi4vdXRpbC9kaWFnbm9zdGljc1wiO1xuaW1wb3J0IHsgVG9rZW4sIFRva2VuS2luZCwgZ2V0VG9rZW5EZXNjcmlwdGlvbiwgVG9rZW5XaXRoVHJpdmlhIH0gZnJvbSBcIi4uL3NjYW5uaW5nL3Rva2Vuc1wiO1xuaW1wb3J0IHtcbiAgRG9jdW1lbnRTeW50YXgsXG4gIFZlcnNpb25TeW50YXgsXG4gIEJsb2NrU3ludGF4LFxuICBCYXNlUHJvcGVydHlTeW50YXgsXG4gIEFycmF5UHJvcGVydHlTeW50YXgsXG4gIEFycmF5SXRlbVN5bnRheCxcbiAgT2JqZWN0TWVtYmVyU3ludGF4LFxuICBTdHJpbmdQcm9wZXJ0eVN5bnRheCxcbiAgT2JqZWN0UHJvcGVydHlTeW50YXgsXG59IGZyb20gXCIuL3N5bnRheC1ub2Rlc1wiO1xuXG5pbnRlcmZhY2UgUGFyc2VDb250ZXh0IHtcbiAgcmVhZG9ubHkgcGFyZW50PzogUGFyc2VDb250ZXh0O1xuICByZWFkb25seSBzdXBwb3J0ZWQ6IFJlYWRvbmx5QXJyYXk8VG9rZW5LaW5kPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlVG9rZW5zKGFsbFRva2VuczogUmVhZG9ubHlBcnJheTxUb2tlbj4sIGJhZzogRGlhZ25vc3RpY0JhZyk6IERvY3VtZW50U3ludGF4IHtcbiAgY29uc3QgdG9rZW5zID0gYWxsVG9rZW5zLmZpbHRlcih0b2tlbiA9PiB0b2tlbi5raW5kICE9PSBUb2tlbktpbmQuVW5yZWNvZ25pemVkKTtcbiAgY29uc3QgY29tbWVudHNBZnRlciA9IGV4dHJhY3RDb21tZW50c0F0RW5kT2ZGaWxlKCk7XG5cbiAgY29uc3QgcmVwb3J0ZWRFcnJvcnMgPSBBcnJheTxib29sZWFuPigpO1xuXG4gIGxldCBpbmRleCA9IDA7XG4gIGNvbnN0IHZlcnNpb25zID0gQXJyYXk8VmVyc2lvblN5bnRheD4oKTtcbiAgY29uc3QgYmxvY2tzID0gQXJyYXk8QmxvY2tTeW50YXg+KCk7XG5cbiAgd2hpbGUgKGluZGV4IDwgdG9rZW5zLmxlbmd0aCkge1xuICAgIHBhcnNlVG9wTGV2ZWxOb2RlKHtcbiAgICAgIHN1cHBvcnRlZDogW10sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gbmV3IERvY3VtZW50U3ludGF4KHZlcnNpb25zLCBibG9ja3MsIGNvbW1lbnRzQWZ0ZXIpO1xuXG4gIGZ1bmN0aW9uIGV4dHJhY3RDb21tZW50c0F0RW5kT2ZGaWxlKCk6IFJlYWRvbmx5QXJyYXk8VG9rZW5XaXRoVHJpdmlhPiB7XG4gICAgbGV0IGVuZCA9IHRva2Vucy5sZW5ndGggLSAxO1xuICAgIHdoaWxlIChlbmQgPj0gMCAmJiB0b2tlbnNbZW5kXS5raW5kID09PSBUb2tlbktpbmQuQ29tbWVudCkge1xuICAgICAgZW5kIC09IDE7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gdG9rZW5zLnNsaWNlKGVuZCArIDEpO1xuICAgIHRva2Vucy5zcGxpY2UoZW5kICsgMSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhcnNlVG9wTGV2ZWxOb2RlKGNvbnRleHQ6IFBhcnNlQ29udGV4dCk6IHZvaWQge1xuICAgIGNvbnN0IGtleXdvcmRLaW5kcyA9IFtUb2tlbktpbmQuVmVyc2lvbktleXdvcmQsIFRva2VuS2luZC5Xb3JrZmxvd0tleXdvcmQsIFRva2VuS2luZC5BY3Rpb25LZXl3b3JkXTtcbiAgICBjb25zdCBrZXl3b3JkID0gZWF0KGNvbnRleHQsIC4uLmtleXdvcmRLaW5kcyk7XG5cbiAgICBjb25zdCBpbm5lckNvbnRleHQgPSB7XG4gICAgICBwYXJlbnQ6IGNvbnRleHQsXG4gICAgICBzdXBwb3J0ZWQ6IGtleXdvcmRLaW5kcyxcbiAgICB9O1xuXG4gICAgc3dpdGNoIChrZXl3b3JkLmtpbmQpIHtcbiAgICAgIGNhc2UgVG9rZW5LaW5kLlZlcnNpb25LZXl3b3JkOiB7XG4gICAgICAgIHBhcnNlVmVyc2lvbihrZXl3b3JkLCBpbm5lckNvbnRleHQpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgVG9rZW5LaW5kLldvcmtmbG93S2V5d29yZDpcbiAgICAgIGNhc2UgVG9rZW5LaW5kLkFjdGlvbktleXdvcmQ6IHtcbiAgICAgICAgcGFyc2VCbG9jayhrZXl3b3JkLCBpbm5lckNvbnRleHQpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgVG9rZW5LaW5kLk1pc3Npbmc6IHtcbiAgICAgICAgLy8gbW92ZSB0byB0aGUgbmV4dCB0b2tlblxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHRva2VuICcke2dldFRva2VuRGVzY3JpcHRpb24oa2V5d29yZC5raW5kKX0nIGhlcmUuYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gcGFyc2VWZXJzaW9uKHZlcnNpb246IFRva2VuV2l0aFRyaXZpYSwgY29udGV4dDogUGFyc2VDb250ZXh0KTogdm9pZCB7XG4gICAgY29uc3QgZXF1YWwgPSBlYXQoY29udGV4dCwgVG9rZW5LaW5kLkVxdWFsKTtcbiAgICBjb25zdCBpbnRlZ2VyID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5JbnRlZ2VyTGl0ZXJhbCk7XG5cbiAgICB2ZXJzaW9ucy5wdXNoKG5ldyBWZXJzaW9uU3ludGF4KHZlcnNpb24sIGVxdWFsLCBpbnRlZ2VyKSk7XG4gIH1cblxuICBmdW5jdGlvbiBwYXJzZUJsb2NrKHR5cGU6IFRva2VuV2l0aFRyaXZpYSwgY29udGV4dDogUGFyc2VDb250ZXh0KTogdm9pZCB7XG4gICAgY29uc3QgbmFtZSA9IGVhdChjb250ZXh0LCBUb2tlbktpbmQuU3RyaW5nTGl0ZXJhbCk7XG4gICAgY29uc3Qgb3BlbkJyYWNrZXQgPSBlYXQoY29udGV4dCwgVG9rZW5LaW5kLkxlZnRDdXJseUJyYWNrZXQpO1xuXG4gICAgY29uc3QgcHJvcGVydGllcyA9IHBhcnNlUHJvcGVydGllcyh7XG4gICAgICBwYXJlbnQ6IGNvbnRleHQsXG4gICAgICBzdXBwb3J0ZWQ6IFtUb2tlbktpbmQuUmlnaHRDdXJseUJyYWNrZXRdLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2xvc2VCcmFja2V0ID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5SaWdodEN1cmx5QnJhY2tldCk7XG4gICAgYmxvY2tzLnB1c2gobmV3IEJsb2NrU3ludGF4KHR5cGUsIG5hbWUsIG9wZW5CcmFja2V0LCBwcm9wZXJ0aWVzLCBjbG9zZUJyYWNrZXQpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhcnNlUHJvcGVydGllcyhjb250ZXh0OiBQYXJzZUNvbnRleHQpOiBSZWFkb25seUFycmF5PEJhc2VQcm9wZXJ0eVN5bnRheD4ge1xuICAgIGNvbnN0IHByb3BlcnRpZXM6IEJhc2VQcm9wZXJ0eVN5bnRheFtdID0gW107XG5cbiAgICB3aGlsZSAoIWlzTmV4dChUb2tlbktpbmQuUmlnaHRDdXJseUJyYWNrZXQpKSB7XG4gICAgICBjb25zdCBrZXlLaW5kcyA9IFtcbiAgICAgICAgVG9rZW5LaW5kLk9uS2V5d29yZCxcbiAgICAgICAgVG9rZW5LaW5kLlJlc29sdmVzS2V5d29yZCxcbiAgICAgICAgVG9rZW5LaW5kLlVzZXNLZXl3b3JkLFxuICAgICAgICBUb2tlbktpbmQuTmVlZHNLZXl3b3JkLFxuICAgICAgICBUb2tlbktpbmQuUnVuc0tleXdvcmQsXG4gICAgICAgIFRva2VuS2luZC5BcmdzS2V5d29yZCxcbiAgICAgICAgVG9rZW5LaW5kLkVudktleXdvcmQsXG4gICAgICAgIFRva2VuS2luZC5TZWNyZXRzS2V5d29yZCxcbiAgICAgIF07XG5cbiAgICAgIGNvbnN0IGtleSA9IGVhdChjb250ZXh0LCAuLi5rZXlLaW5kcyk7XG4gICAgICBpZiAoa2V5LmtpbmQgPT09IFRva2VuS2luZC5NaXNzaW5nKSB7XG4gICAgICAgIC8vIFN0b3AgbG9va2luZyBmb3IgcHJvcGVydGllc1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgcHJvcGVydGllcy5wdXNoKFxuICAgICAgICBwYXJzZVByb3BlcnR5KGtleSwge1xuICAgICAgICAgIHBhcmVudDogY29udGV4dCxcbiAgICAgICAgICBzdXBwb3J0ZWQ6IGtleUtpbmRzLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG4gIH1cblxuICBmdW5jdGlvbiBwYXJzZVByb3BlcnR5KGtleTogVG9rZW5XaXRoVHJpdmlhLCBjb250ZXh0OiBQYXJzZUNvbnRleHQpOiBCYXNlUHJvcGVydHlTeW50YXgge1xuICAgIGNvbnN0IGVxdWFsID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5FcXVhbCk7XG4gICAgY29uc3QgdmFsdWVTdGFydCA9IGVhdChjb250ZXh0LCBUb2tlbktpbmQuU3RyaW5nTGl0ZXJhbCwgVG9rZW5LaW5kLkxlZnRDdXJseUJyYWNrZXQsIFRva2VuS2luZC5MZWZ0U3F1YXJlQnJhY2tldCk7XG5cbiAgICBsZXQgcHJvcGVydHk6IEJhc2VQcm9wZXJ0eVN5bnRheDtcbiAgICBzd2l0Y2ggKHZhbHVlU3RhcnQua2luZCkge1xuICAgICAgY2FzZSBUb2tlbktpbmQuU3RyaW5nTGl0ZXJhbDoge1xuICAgICAgICBwcm9wZXJ0eSA9IG5ldyBTdHJpbmdQcm9wZXJ0eVN5bnRheChrZXksIGVxdWFsLCB2YWx1ZVN0YXJ0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFRva2VuS2luZC5MZWZ0U3F1YXJlQnJhY2tldDoge1xuICAgICAgICBjb25zdCBpdGVtcyA9IHBhcnNlQXJyYXlJdGVtcyhjb250ZXh0KTtcbiAgICAgICAgY29uc3QgY2xvc2VCcmFja2V0ID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5SaWdodFNxdWFyZUJyYWNrZXQpO1xuICAgICAgICBwcm9wZXJ0eSA9IG5ldyBBcnJheVByb3BlcnR5U3ludGF4KGtleSwgZXF1YWwsIHZhbHVlU3RhcnQsIGl0ZW1zLCBjbG9zZUJyYWNrZXQpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgVG9rZW5LaW5kLkxlZnRDdXJseUJyYWNrZXQ6IHtcbiAgICAgICAgY29uc3QgbWVtYmVycyA9IHBhcnNlT2JqZWN0TWVtYmVycyhjb250ZXh0KTtcbiAgICAgICAgY29uc3QgY2xvc2VCcmFja2V0ID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5SaWdodEN1cmx5QnJhY2tldCk7XG4gICAgICAgIHByb3BlcnR5ID0gbmV3IE9iamVjdFByb3BlcnR5U3ludGF4KGtleSwgZXF1YWwsIHZhbHVlU3RhcnQsIG1lbWJlcnMsIGNsb3NlQnJhY2tldCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBUb2tlbktpbmQuTWlzc2luZzoge1xuICAgICAgICAvLyBJbnNlcnQgbWlzc2luZyB2YWx1ZSBhcyBhIHN0cmluZyBwcm9wZXJ0eVxuICAgICAgICBwcm9wZXJ0eSA9IG5ldyBTdHJpbmdQcm9wZXJ0eVN5bnRheChrZXksIGVxdWFsLCB2YWx1ZVN0YXJ0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0b2tlbiAnJHtnZXRUb2tlbkRlc2NyaXB0aW9uKHZhbHVlU3RhcnQua2luZCl9JyBoZXJlLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBwcm9wZXJ0eTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhcnNlQXJyYXlJdGVtcyhjb250ZXh0OiBQYXJzZUNvbnRleHQpOiBSZWFkb25seUFycmF5PEFycmF5SXRlbVN5bnRheD4ge1xuICAgIGNvbnN0IGl0ZW1zID0gQXJyYXk8QXJyYXlJdGVtU3ludGF4PigpO1xuXG4gICAgd2hpbGUgKCFpc05leHQoVG9rZW5LaW5kLlJpZ2h0U3F1YXJlQnJhY2tldCkpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5TdHJpbmdMaXRlcmFsKTtcblxuICAgICAgaWYgKHZhbHVlLmtpbmQgPT09IFRva2VuS2luZC5NaXNzaW5nKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBsZXQgY29tbWE6IFRva2VuV2l0aFRyaXZpYSB8IHVuZGVmaW5lZDtcbiAgICAgIGlmIChpc05leHQoVG9rZW5LaW5kLkNvbW1hKSkge1xuICAgICAgICBjb21tYSA9IGVhdChjb250ZXh0LCBUb2tlbktpbmQuQ29tbWEpO1xuICAgICAgfVxuXG4gICAgICBpdGVtcy5wdXNoKG5ldyBBcnJheUl0ZW1TeW50YXgodmFsdWUsIGNvbW1hKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGl0ZW1zO1xuICB9XG5cbiAgZnVuY3Rpb24gcGFyc2VPYmplY3RNZW1iZXJzKGNvbnRleHQ6IFBhcnNlQ29udGV4dCk6IFJlYWRvbmx5QXJyYXk8T2JqZWN0TWVtYmVyU3ludGF4PiB7XG4gICAgY29uc3QgbWVtYmVycyA9IEFycmF5PE9iamVjdE1lbWJlclN5bnRheD4oKTtcblxuICAgIHdoaWxlICghaXNOZXh0KFRva2VuS2luZC5SaWdodEN1cmx5QnJhY2tldCkpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBlYXQoY29udGV4dCwgVG9rZW5LaW5kLklkZW50aWZpZXIpO1xuXG4gICAgICBpZiAobmFtZS5raW5kID09PSBUb2tlbktpbmQuTWlzc2luZykge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXF1YWwgPSBlYXQoY29udGV4dCwgVG9rZW5LaW5kLkVxdWFsKTtcbiAgICAgIGNvbnN0IHZhbHVlID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5TdHJpbmdMaXRlcmFsKTtcbiAgICAgIGxldCBjb21tYTogVG9rZW5XaXRoVHJpdmlhIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKGlzTmV4dChUb2tlbktpbmQuQ29tbWEpKSB7XG4gICAgICAgIGNvbW1hID0gZWF0KGNvbnRleHQsIFRva2VuS2luZC5Db21tYSk7XG4gICAgICB9XG5cbiAgICAgIG1lbWJlcnMucHVzaChuZXcgT2JqZWN0TWVtYmVyU3ludGF4KG5hbWUsIGVxdWFsLCB2YWx1ZSwgY29tbWEpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVtYmVycztcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzTmV4dChraW5kOiBUb2tlbktpbmQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gaW5kZXggPCB0b2tlbnMubGVuZ3RoICYmIHRva2Vuc1tpbmRleF0ua2luZCA9PT0ga2luZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGVhdChjb250ZXh0OiBQYXJzZUNvbnRleHQsIC4uLmV4cGVjdGVkOiBUb2tlbktpbmRbXSk6IFRva2VuV2l0aFRyaXZpYSB7XG4gICAgY29uc3QgY29tbWVudHNCZWZvcmUgPSBlYXRDb21tZW50cygpO1xuXG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGlmIChpbmRleCA+PSB0b2tlbnMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tbWVudHNCZWZvcmUsXG4gICAgICAgICAgLi4ubWlzc2luZ1Rva2VuKGV4cGVjdGVkKSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY3VycmVudCA9IHRva2Vuc1tpbmRleF07XG4gICAgICBpZiAoZXhwZWN0ZWQuaW5jbHVkZXMoY3VycmVudC5raW5kKSkge1xuICAgICAgICBpbmRleCArPSAxO1xuXG4gICAgICAgIGlmIChpbmRleCA8IHRva2Vucy5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBjb21tZW50QWZ0ZXIgPSB0b2tlbnNbaW5kZXhdO1xuICAgICAgICAgIGlmIChjb21tZW50QWZ0ZXIua2luZCA9PT0gVG9rZW5LaW5kLkNvbW1lbnQgJiYgY29tbWVudEFmdGVyLnJhbmdlLnN0YXJ0LmxpbmUgPT09IGN1cnJlbnQucmFuZ2UuZW5kLmxpbmUpIHtcbiAgICAgICAgICAgIGluZGV4ICs9IDE7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBjb21tZW50c0JlZm9yZSxcbiAgICAgICAgICAgICAgLi4uY3VycmVudCxcbiAgICAgICAgICAgICAgY29tbWVudEFmdGVyLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbW1lbnRzQmVmb3JlLFxuICAgICAgICAgIC4uLmN1cnJlbnQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGxldCBjYW5CZUhhbmRsZWRCeVBhcmVudCA9IGZhbHNlO1xuICAgICAgbGV0IGN1cnJlbnRDb250ZXh0OiBQYXJzZUNvbnRleHQgfCB1bmRlZmluZWQgPSBjb250ZXh0O1xuICAgICAgd2hpbGUgKCFjYW5CZUhhbmRsZWRCeVBhcmVudCAmJiBjdXJyZW50Q29udGV4dCkge1xuICAgICAgICBjYW5CZUhhbmRsZWRCeVBhcmVudCA9IGN1cnJlbnRDb250ZXh0LnN1cHBvcnRlZC5pbmNsdWRlcyhjdXJyZW50LmtpbmQpO1xuICAgICAgICBjdXJyZW50Q29udGV4dCA9IGN1cnJlbnRDb250ZXh0LnBhcmVudDtcbiAgICAgIH1cblxuICAgICAgaWYgKGNhbkJlSGFuZGxlZEJ5UGFyZW50KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tbWVudHNCZWZvcmUsXG4gICAgICAgICAgLi4ubWlzc2luZ1Rva2VuKGV4cGVjdGVkKSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFyZXBvcnRlZEVycm9yc1tpbmRleF0pIHtcbiAgICAgICAgYmFnLnVuZXhwZWN0ZWRUb2tlbihjdXJyZW50KTtcbiAgICAgICAgcmVwb3J0ZWRFcnJvcnNbaW5kZXhdID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaW5kZXggKz0gMTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBlYXRDb21tZW50cygpOiBSZWFkb25seUFycmF5PFRva2VuV2l0aFRyaXZpYT4gfCB1bmRlZmluZWQge1xuICAgIGxldCByZXN1bHQ6IFRva2VuV2l0aFRyaXZpYVtdIHwgdW5kZWZpbmVkO1xuXG4gICAgd2hpbGUgKGluZGV4IDwgdG9rZW5zLmxlbmd0aCAmJiB0b2tlbnNbaW5kZXhdLmtpbmQgPT09IFRva2VuS2luZC5Db21tZW50KSB7XG4gICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICByZXN1bHQgPSBbXTtcbiAgICAgIH1cblxuICAgICAgcmVzdWx0LnB1c2godG9rZW5zW2luZGV4XSk7XG4gICAgICBpbmRleCArPSAxO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBmdW5jdGlvbiBtaXNzaW5nVG9rZW4oZXhwZWN0ZWQ6IFRva2VuS2luZFtdKTogVG9rZW4ge1xuICAgIGxldCBtaXNzaW5nSW5kZXggPSBpbmRleDtcbiAgICBjb25zdCBlbmRPZkZpbGUgPSBpbmRleCA+PSB0b2tlbnMubGVuZ3RoO1xuICAgIGlmIChlbmRPZkZpbGUpIHtcbiAgICAgIG1pc3NpbmdJbmRleCA9IHRva2Vucy5sZW5ndGggLSAxO1xuICAgIH1cblxuICAgIGNvbnN0IHJhbmdlID0gdG9rZW5zW21pc3NpbmdJbmRleF0ucmFuZ2U7XG4gICAgaWYgKCFyZXBvcnRlZEVycm9yc1ttaXNzaW5nSW5kZXhdKSB7XG4gICAgICBiYWcubWlzc2luZ1Rva2VuKGV4cGVjdGVkLCByYW5nZSwgZW5kT2ZGaWxlKTtcbiAgICAgIHJlcG9ydGVkRXJyb3JzW21pc3NpbmdJbmRleF0gPSB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICByYW5nZSxcbiAgICAgIGtpbmQ6IFRva2VuS2luZC5NaXNzaW5nLFxuICAgICAgdGV4dDogXCJcIixcbiAgICB9O1xuICB9XG59XG4iXX0=
