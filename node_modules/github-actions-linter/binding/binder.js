"use strict";
/*!
 * Copyright 2019 Omar Tawfik. Please see LICENSE file at the root of this repository.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var syntax_nodes_1 = require("../parsing/syntax-nodes");
var bound_nodes_1 = require("./bound-nodes");
var tokens_1 = require("../scanning/tokens");
var webhooks = require("@octokit/webhooks-definitions");
var constants_1 = require("../util/constants");
var ON_SCHEDULE_REGEX = /schedule\(.+\)/;
function bindDocument(root, bag) {
    var version;
    var workflows = Array();
    var actions = Array();
    root.versions.forEach(function (syntax) {
        bindVersion(syntax);
    });
    var reportedErrorOnMisplacedVersion = false;
    root.blocks.forEach(function (syntax) {
        if (!reportedErrorOnMisplacedVersion &&
            version &&
            syntax.type.range.start.line < version.syntax.version.range.start.line) {
            bag.versionAfterBlock(version.syntax.version.range);
            reportedErrorOnMisplacedVersion = true;
        }
        switch (syntax.type.kind) {
            case tokens_1.TokenKind.WorkflowKeyword: {
                bindWorkflow(syntax);
                break;
            }
            case tokens_1.TokenKind.ActionKeyword: {
                bindAction(syntax);
                break;
            }
            default: {
                throw new Error("Unexpected block kind '" + syntax.type.kind + "' here.");
            }
        }
    });
    return new bound_nodes_1.BoundDocument(version, workflows, actions, root);
    function bindVersion(syntax) {
        if (version) {
            bag.multipleVersions(syntax.version.range);
        }
        else {
            var value = 0;
            if (syntax.integer.kind !== tokens_1.TokenKind.Missing) {
                value = parseInt(syntax.integer.text, 10);
                if (isNaN(value) || value < 0 || value > constants_1.MAXIMUM_SUPPORTED_VERSION) {
                    bag.unrecognizedVersion(syntax.integer.text, syntax.integer.range);
                }
            }
            version = new bound_nodes_1.BoundVersion(value, syntax);
        }
    }
    function bindWorkflow(syntax) {
        var on;
        var resolves;
        syntax.properties.forEach(function (property) {
            switch (property.key.kind) {
                case tokens_1.TokenKind.OnKeyword: {
                    if (on) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        on = new bound_nodes_1.BoundOn(bindString(property), property);
                        if (on.event) {
                            var value_1 = on.event.value;
                            if (!webhooks.some(function (definition) { return definition.name === value_1; }) && !ON_SCHEDULE_REGEX.test(value_1)) {
                                bag.unrecognizedEvent(value_1, on.event.syntax.range);
                            }
                        }
                    }
                    break;
                }
                case tokens_1.TokenKind.ResolvesKeyword: {
                    if (resolves) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        resolves = new bound_nodes_1.BoundResolves(bindStringOrArray(property), property);
                    }
                    break;
                }
                default: {
                    bag.invalidProperty(property.key, syntax.type.kind);
                }
            }
        });
        if (!on) {
            bag.propertyMustBeDefined(tokens_1.TokenKind.OnKeyword, syntax.type);
        }
        workflows.push(new bound_nodes_1.BoundWorkflow(removeDoubleQuotes(syntax.name.text), on, resolves, syntax));
    }
    function bindAction(syntax) {
        var uses;
        var needs;
        var runs;
        var args;
        var env;
        var secrets;
        syntax.properties.forEach(function (property) {
            switch (property.key.kind) {
                case tokens_1.TokenKind.UsesKeyword: {
                    if (uses) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        uses = new bound_nodes_1.BoundUses(bindString(property), property);
                        if (uses.value) {
                            if (!constants_1.USES_REGEX.test(uses.value.value)) {
                                bag.invalidUses(uses.value.syntax.range);
                            }
                        }
                    }
                    break;
                }
                case tokens_1.TokenKind.NeedsKeyword: {
                    if (needs) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        needs = new bound_nodes_1.BoundNeeds(bindStringOrArray(property), property);
                    }
                    break;
                }
                case tokens_1.TokenKind.RunsKeyword: {
                    if (runs) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        runs = new bound_nodes_1.BoundRuns(bindStringOrArray(property), property);
                    }
                    break;
                }
                case tokens_1.TokenKind.ArgsKeyword: {
                    if (args) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        args = new bound_nodes_1.BoundArgs(bindStringOrArray(property), property);
                    }
                    break;
                }
                case tokens_1.TokenKind.EnvKeyword: {
                    if (env) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        env = new bound_nodes_1.BoundEnv(bindObject(property), property);
                        env.variables.forEach(function (variable) {
                            if (variable.name.startsWith("GITHUB_")) {
                                bag.reservedEnvironmentVariable(variable.syntax.name.range);
                            }
                        });
                    }
                    break;
                }
                case tokens_1.TokenKind.SecretsKeyword: {
                    if (secrets) {
                        bag.propertyAlreadyDefined(property.key);
                    }
                    else {
                        secrets = new bound_nodes_1.BoundSecrets(bindStringOrArray(property), property);
                    }
                    break;
                }
                default: {
                    bag.invalidProperty(property.key, syntax.type.kind);
                }
            }
        });
        if (!uses) {
            bag.propertyMustBeDefined(tokens_1.TokenKind.UsesKeyword, syntax.type);
        }
        actions.push(new bound_nodes_1.BoundAction(removeDoubleQuotes(syntax.name.text), uses, needs, runs, args, env, secrets, syntax));
    }
    function bindString(syntax) {
        if (!syntax) {
            return undefined;
        }
        switch (syntax.kind) {
            case syntax_nodes_1.SyntaxKind.StringProperty: {
                var property = syntax;
                if (property.value && property.value.kind !== tokens_1.TokenKind.Missing) {
                    var value = removeDoubleQuotes(property.value.text);
                    return new bound_nodes_1.BoundStringValue(value, property.value);
                }
                return undefined;
            }
            case syntax_nodes_1.SyntaxKind.ArrayProperty: {
                bag.valueIsNotString(syntax.key.range);
                return undefined;
            }
            case syntax_nodes_1.SyntaxKind.ObjectProperty: {
                bag.valueIsNotString(syntax.key.range);
                return undefined;
            }
            default: {
                throw new Error("Unexpected Syntax kind '" + syntax.kind + "'");
            }
        }
    }
    function bindStringOrArray(syntax) {
        if (!syntax) {
            return [];
        }
        switch (syntax.kind) {
            case syntax_nodes_1.SyntaxKind.StringProperty: {
                var property = syntax;
                if (property.value && property.value.kind !== tokens_1.TokenKind.Missing) {
                    var value = removeDoubleQuotes(property.value.text);
                    return [new bound_nodes_1.BoundStringValue(value, property.value)];
                }
                return [];
            }
            case syntax_nodes_1.SyntaxKind.ArrayProperty: {
                return syntax.items
                    .filter(function (item) { return item.value.kind !== tokens_1.TokenKind.Missing; })
                    .map(function (item) { return new bound_nodes_1.BoundStringValue(removeDoubleQuotes(item.value.text), item.value); });
            }
            case syntax_nodes_1.SyntaxKind.ObjectProperty: {
                bag.valueIsNotStringOrArray(syntax.key.range);
                return [];
            }
            default: {
                throw new Error("Unexpected Syntax kind '" + syntax.kind + "'");
            }
        }
    }
    function bindObject(syntax) {
        if (!syntax) {
            return [];
        }
        switch (syntax.kind) {
            case syntax_nodes_1.SyntaxKind.StringProperty: {
                bag.valueIsNotAnObject(syntax.key.range);
                return [];
            }
            case syntax_nodes_1.SyntaxKind.ArrayProperty: {
                bag.valueIsNotAnObject(syntax.key.range);
                return [];
            }
            case syntax_nodes_1.SyntaxKind.ObjectProperty: {
                return syntax.members
                    .filter(function (member) { return member.name.kind !== tokens_1.TokenKind.Missing && member.value.kind !== tokens_1.TokenKind.Missing; })
                    .map(function (member) { return new bound_nodes_1.BoundObjectMember(member.name.text, removeDoubleQuotes(member.value.text), member); });
            }
            default: {
                throw new Error("Unexpected Syntax kind '" + syntax.kind + "'");
            }
        }
    }
    function removeDoubleQuotes(value) {
        if (value.length === 0) {
            return value;
        }
        if (!value.startsWith('"')) {
            throw new Error("value has to start with double quotes");
        }
        if (value.endsWith('"')) {
            return value.substr(1, value.length - 2);
        }
        // in case of an incomplete token
        return value.substr(1);
    }
}
exports.bindDocument = bindDocument;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7U0FDMUQ7UUFFRCxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDdkIsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzFDO1FBRUQsaUNBQWlDO1FBQ2pDLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6QixDQUFDO0FBQ0gsQ0FBQztBQWhSRCxvQ0FnUkMiLCJmaWxlIjoic3JjL2JpbmRpbmcvYmluZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgMjAxOSBPbWFyIFRhd2Zpay4gUGxlYXNlIHNlZSBMSUNFTlNFIGZpbGUgYXQgdGhlIHJvb3Qgb2YgdGhpcyByZXBvc2l0b3J5LlxuICovXG5cbmltcG9ydCB7IERpYWdub3N0aWNCYWcgfSBmcm9tIFwiLi4vdXRpbC9kaWFnbm9zdGljc1wiO1xuaW1wb3J0IHtcbiAgRG9jdW1lbnRTeW50YXgsXG4gIFZlcnNpb25TeW50YXgsXG4gIEJsb2NrU3ludGF4LFxuICBTeW50YXhLaW5kLFxuICBCYXNlUHJvcGVydHlTeW50YXgsXG4gIFN0cmluZ1Byb3BlcnR5U3ludGF4LFxuICBBcnJheVByb3BlcnR5U3ludGF4LFxuICBPYmplY3RQcm9wZXJ0eVN5bnRheCxcbn0gZnJvbSBcIi4uL3BhcnNpbmcvc3ludGF4LW5vZGVzXCI7XG5pbXBvcnQge1xuICBCb3VuZERvY3VtZW50LFxuICBCb3VuZFZlcnNpb24sXG4gIEJvdW5kQWN0aW9uLFxuICBCb3VuZFdvcmtmbG93LFxuICBCb3VuZE9uLFxuICBCb3VuZFJlc29sdmVzLFxuICBCb3VuZE5lZWRzLFxuICBCb3VuZFJ1bnMsXG4gIEJvdW5kQXJncyxcbiAgQm91bmRFbnYsXG4gIEJvdW5kU2VjcmV0cyxcbiAgQm91bmRVc2VzLFxuICBCb3VuZFN0cmluZ1ZhbHVlLFxuICBCb3VuZE9iamVjdE1lbWJlcixcbn0gZnJvbSBcIi4vYm91bmQtbm9kZXNcIjtcbmltcG9ydCB7IFRva2VuS2luZCB9IGZyb20gXCIuLi9zY2FubmluZy90b2tlbnNcIjtcbmltcG9ydCAqIGFzIHdlYmhvb2tzIGZyb20gXCJAb2N0b2tpdC93ZWJob29rcy1kZWZpbml0aW9uc1wiO1xuaW1wb3J0IHsgTUFYSU1VTV9TVVBQT1JURURfVkVSU0lPTiwgVVNFU19SRUdFWCB9IGZyb20gXCIuLi91dGlsL2NvbnN0YW50c1wiO1xuXG5jb25zdCBPTl9TQ0hFRFVMRV9SRUdFWCA9IC9zY2hlZHVsZVxcKC4rXFwpLztcblxuZXhwb3J0IGZ1bmN0aW9uIGJpbmREb2N1bWVudChyb290OiBEb2N1bWVudFN5bnRheCwgYmFnOiBEaWFnbm9zdGljQmFnKTogQm91bmREb2N1bWVudCB7XG4gIGxldCB2ZXJzaW9uOiBCb3VuZFZlcnNpb24gfCB1bmRlZmluZWQ7XG4gIGNvbnN0IHdvcmtmbG93cyA9IEFycmF5PEJvdW5kV29ya2Zsb3c+KCk7XG4gIGNvbnN0IGFjdGlvbnMgPSBBcnJheTxCb3VuZEFjdGlvbj4oKTtcblxuICByb290LnZlcnNpb25zLmZvckVhY2goc3ludGF4ID0+IHtcbiAgICBiaW5kVmVyc2lvbihzeW50YXgpO1xuICB9KTtcblxuICBsZXQgcmVwb3J0ZWRFcnJvck9uTWlzcGxhY2VkVmVyc2lvbiA9IGZhbHNlO1xuICByb290LmJsb2Nrcy5mb3JFYWNoKHN5bnRheCA9PiB7XG4gICAgaWYgKFxuICAgICAgIXJlcG9ydGVkRXJyb3JPbk1pc3BsYWNlZFZlcnNpb24gJiZcbiAgICAgIHZlcnNpb24gJiZcbiAgICAgIHN5bnRheC50eXBlLnJhbmdlLnN0YXJ0LmxpbmUgPCB2ZXJzaW9uLnN5bnRheC52ZXJzaW9uLnJhbmdlLnN0YXJ0LmxpbmVcbiAgICApIHtcbiAgICAgIGJhZy52ZXJzaW9uQWZ0ZXJCbG9jayh2ZXJzaW9uLnN5bnRheC52ZXJzaW9uLnJhbmdlKTtcbiAgICAgIHJlcG9ydGVkRXJyb3JPbk1pc3BsYWNlZFZlcnNpb24gPSB0cnVlO1xuICAgIH1cblxuICAgIHN3aXRjaCAoc3ludGF4LnR5cGUua2luZCkge1xuICAgICAgY2FzZSBUb2tlbktpbmQuV29ya2Zsb3dLZXl3b3JkOiB7XG4gICAgICAgIGJpbmRXb3JrZmxvdyhzeW50YXgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgVG9rZW5LaW5kLkFjdGlvbktleXdvcmQ6IHtcbiAgICAgICAgYmluZEFjdGlvbihzeW50YXgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGJsb2NrIGtpbmQgJyR7c3ludGF4LnR5cGUua2luZH0nIGhlcmUuYCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gbmV3IEJvdW5kRG9jdW1lbnQodmVyc2lvbiwgd29ya2Zsb3dzLCBhY3Rpb25zLCByb290KTtcblxuICBmdW5jdGlvbiBiaW5kVmVyc2lvbihzeW50YXg6IFZlcnNpb25TeW50YXgpOiB2b2lkIHtcbiAgICBpZiAodmVyc2lvbikge1xuICAgICAgYmFnLm11bHRpcGxlVmVyc2lvbnMoc3ludGF4LnZlcnNpb24ucmFuZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgdmFsdWUgPSAwO1xuICAgICAgaWYgKHN5bnRheC5pbnRlZ2VyLmtpbmQgIT09IFRva2VuS2luZC5NaXNzaW5nKSB7XG4gICAgICAgIHZhbHVlID0gcGFyc2VJbnQoc3ludGF4LmludGVnZXIudGV4dCwgMTApO1xuICAgICAgICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlIDwgMCB8fCB2YWx1ZSA+IE1BWElNVU1fU1VQUE9SVEVEX1ZFUlNJT04pIHtcbiAgICAgICAgICBiYWcudW5yZWNvZ25pemVkVmVyc2lvbihzeW50YXguaW50ZWdlci50ZXh0LCBzeW50YXguaW50ZWdlci5yYW5nZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHZlcnNpb24gPSBuZXcgQm91bmRWZXJzaW9uKHZhbHVlLCBzeW50YXgpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGJpbmRXb3JrZmxvdyhzeW50YXg6IEJsb2NrU3ludGF4KTogdm9pZCB7XG4gICAgbGV0IG9uOiBCb3VuZE9uIHwgdW5kZWZpbmVkO1xuICAgIGxldCByZXNvbHZlczogQm91bmRSZXNvbHZlcyB8IHVuZGVmaW5lZDtcblxuICAgIHN5bnRheC5wcm9wZXJ0aWVzLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgc3dpdGNoIChwcm9wZXJ0eS5rZXkua2luZCkge1xuICAgICAgICBjYXNlIFRva2VuS2luZC5PbktleXdvcmQ6IHtcbiAgICAgICAgICBpZiAob24pIHtcbiAgICAgICAgICAgIGJhZy5wcm9wZXJ0eUFscmVhZHlEZWZpbmVkKHByb3BlcnR5LmtleSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9uID0gbmV3IEJvdW5kT24oYmluZFN0cmluZyhwcm9wZXJ0eSksIHByb3BlcnR5KTtcbiAgICAgICAgICAgIGlmIChvbi5ldmVudCkge1xuICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBvbi5ldmVudDtcbiAgICAgICAgICAgICAgaWYgKCF3ZWJob29rcy5zb21lKGRlZmluaXRpb24gPT4gZGVmaW5pdGlvbi5uYW1lID09PSB2YWx1ZSkgJiYgIU9OX1NDSEVEVUxFX1JFR0VYLnRlc3QodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgYmFnLnVucmVjb2duaXplZEV2ZW50KHZhbHVlLCBvbi5ldmVudC5zeW50YXgucmFuZ2UpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgVG9rZW5LaW5kLlJlc29sdmVzS2V5d29yZDoge1xuICAgICAgICAgIGlmIChyZXNvbHZlcykge1xuICAgICAgICAgICAgYmFnLnByb3BlcnR5QWxyZWFkeURlZmluZWQocHJvcGVydHkua2V5KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZXMgPSBuZXcgQm91bmRSZXNvbHZlcyhiaW5kU3RyaW5nT3JBcnJheShwcm9wZXJ0eSksIHByb3BlcnR5KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgIGJhZy5pbnZhbGlkUHJvcGVydHkocHJvcGVydHkua2V5LCBzeW50YXgudHlwZS5raW5kKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKCFvbikge1xuICAgICAgYmFnLnByb3BlcnR5TXVzdEJlRGVmaW5lZChUb2tlbktpbmQuT25LZXl3b3JkLCBzeW50YXgudHlwZSk7XG4gICAgfVxuXG4gICAgd29ya2Zsb3dzLnB1c2gobmV3IEJvdW5kV29ya2Zsb3cocmVtb3ZlRG91YmxlUXVvdGVzKHN5bnRheC5uYW1lLnRleHQpLCBvbiwgcmVzb2x2ZXMsIHN5bnRheCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gYmluZEFjdGlvbihzeW50YXg6IEJsb2NrU3ludGF4KTogdm9pZCB7XG4gICAgbGV0IHVzZXM6IEJvdW5kVXNlcyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgbmVlZHM6IEJvdW5kTmVlZHMgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHJ1bnM6IEJvdW5kUnVucyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgYXJnczogQm91bmRBcmdzIHwgdW5kZWZpbmVkO1xuICAgIGxldCBlbnY6IEJvdW5kRW52IHwgdW5kZWZpbmVkO1xuICAgIGxldCBzZWNyZXRzOiBCb3VuZFNlY3JldHMgfCB1bmRlZmluZWQ7XG5cbiAgICBzeW50YXgucHJvcGVydGllcy5mb3JFYWNoKHByb3BlcnR5ID0+IHtcbiAgICAgIHN3aXRjaCAocHJvcGVydHkua2V5LmtpbmQpIHtcbiAgICAgICAgY2FzZSBUb2tlbktpbmQuVXNlc0tleXdvcmQ6IHtcbiAgICAgICAgICBpZiAodXNlcykge1xuICAgICAgICAgICAgYmFnLnByb3BlcnR5QWxyZWFkeURlZmluZWQocHJvcGVydHkua2V5KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdXNlcyA9IG5ldyBCb3VuZFVzZXMoYmluZFN0cmluZyhwcm9wZXJ0eSksIHByb3BlcnR5KTtcbiAgICAgICAgICAgIGlmICh1c2VzLnZhbHVlKSB7XG4gICAgICAgICAgICAgIGlmICghVVNFU19SRUdFWC50ZXN0KHVzZXMudmFsdWUudmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgYmFnLmludmFsaWRVc2VzKHVzZXMudmFsdWUuc3ludGF4LnJhbmdlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFRva2VuS2luZC5OZWVkc0tleXdvcmQ6IHtcbiAgICAgICAgICBpZiAobmVlZHMpIHtcbiAgICAgICAgICAgIGJhZy5wcm9wZXJ0eUFscmVhZHlEZWZpbmVkKHByb3BlcnR5LmtleSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5lZWRzID0gbmV3IEJvdW5kTmVlZHMoYmluZFN0cmluZ09yQXJyYXkocHJvcGVydHkpLCBwcm9wZXJ0eSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgVG9rZW5LaW5kLlJ1bnNLZXl3b3JkOiB7XG4gICAgICAgICAgaWYgKHJ1bnMpIHtcbiAgICAgICAgICAgIGJhZy5wcm9wZXJ0eUFscmVhZHlEZWZpbmVkKHByb3BlcnR5LmtleSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJ1bnMgPSBuZXcgQm91bmRSdW5zKGJpbmRTdHJpbmdPckFycmF5KHByb3BlcnR5KSwgcHJvcGVydHkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFRva2VuS2luZC5BcmdzS2V5d29yZDoge1xuICAgICAgICAgIGlmIChhcmdzKSB7XG4gICAgICAgICAgICBiYWcucHJvcGVydHlBbHJlYWR5RGVmaW5lZChwcm9wZXJ0eS5rZXkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhcmdzID0gbmV3IEJvdW5kQXJncyhiaW5kU3RyaW5nT3JBcnJheShwcm9wZXJ0eSksIHByb3BlcnR5KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBUb2tlbktpbmQuRW52S2V5d29yZDoge1xuICAgICAgICAgIGlmIChlbnYpIHtcbiAgICAgICAgICAgIGJhZy5wcm9wZXJ0eUFscmVhZHlEZWZpbmVkKHByb3BlcnR5LmtleSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVudiA9IG5ldyBCb3VuZEVudihiaW5kT2JqZWN0KHByb3BlcnR5KSwgcHJvcGVydHkpO1xuICAgICAgICAgICAgZW52LnZhcmlhYmxlcy5mb3JFYWNoKHZhcmlhYmxlID0+IHtcbiAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlLm5hbWUuc3RhcnRzV2l0aChcIkdJVEhVQl9cIikpIHtcbiAgICAgICAgICAgICAgICBiYWcucmVzZXJ2ZWRFbnZpcm9ubWVudFZhcmlhYmxlKHZhcmlhYmxlLnN5bnRheC5uYW1lLnJhbmdlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgVG9rZW5LaW5kLlNlY3JldHNLZXl3b3JkOiB7XG4gICAgICAgICAgaWYgKHNlY3JldHMpIHtcbiAgICAgICAgICAgIGJhZy5wcm9wZXJ0eUFscmVhZHlEZWZpbmVkKHByb3BlcnR5LmtleSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNlY3JldHMgPSBuZXcgQm91bmRTZWNyZXRzKGJpbmRTdHJpbmdPckFycmF5KHByb3BlcnR5KSwgcHJvcGVydHkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgYmFnLmludmFsaWRQcm9wZXJ0eShwcm9wZXJ0eS5rZXksIHN5bnRheC50eXBlLmtpbmQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXMpIHtcbiAgICAgIGJhZy5wcm9wZXJ0eU11c3RCZURlZmluZWQoVG9rZW5LaW5kLlVzZXNLZXl3b3JkLCBzeW50YXgudHlwZSk7XG4gICAgfVxuXG4gICAgYWN0aW9ucy5wdXNoKG5ldyBCb3VuZEFjdGlvbihyZW1vdmVEb3VibGVRdW90ZXMoc3ludGF4Lm5hbWUudGV4dCksIHVzZXMsIG5lZWRzLCBydW5zLCBhcmdzLCBlbnYsIHNlY3JldHMsIHN5bnRheCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gYmluZFN0cmluZyhzeW50YXg6IEJhc2VQcm9wZXJ0eVN5bnRheCB8IHVuZGVmaW5lZCk6IEJvdW5kU3RyaW5nVmFsdWUgfCB1bmRlZmluZWQge1xuICAgIGlmICghc3ludGF4KSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHN3aXRjaCAoc3ludGF4LmtpbmQpIHtcbiAgICAgIGNhc2UgU3ludGF4S2luZC5TdHJpbmdQcm9wZXJ0eToge1xuICAgICAgICBjb25zdCBwcm9wZXJ0eSA9IHN5bnRheCBhcyBTdHJpbmdQcm9wZXJ0eVN5bnRheDtcbiAgICAgICAgaWYgKHByb3BlcnR5LnZhbHVlICYmIHByb3BlcnR5LnZhbHVlLmtpbmQgIT09IFRva2VuS2luZC5NaXNzaW5nKSB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSByZW1vdmVEb3VibGVRdW90ZXMocHJvcGVydHkudmFsdWUudGV4dCk7XG4gICAgICAgICAgcmV0dXJuIG5ldyBCb3VuZFN0cmluZ1ZhbHVlKHZhbHVlLCBwcm9wZXJ0eS52YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIGNhc2UgU3ludGF4S2luZC5BcnJheVByb3BlcnR5OiB7XG4gICAgICAgIGJhZy52YWx1ZUlzTm90U3RyaW5nKHN5bnRheC5rZXkucmFuZ2UpO1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgICAgY2FzZSBTeW50YXhLaW5kLk9iamVjdFByb3BlcnR5OiB7XG4gICAgICAgIGJhZy52YWx1ZUlzTm90U3RyaW5nKHN5bnRheC5rZXkucmFuZ2UpO1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgU3ludGF4IGtpbmQgJyR7c3ludGF4LmtpbmR9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGJpbmRTdHJpbmdPckFycmF5KHN5bnRheDogQmFzZVByb3BlcnR5U3ludGF4IHwgdW5kZWZpbmVkKTogUmVhZG9ubHlBcnJheTxCb3VuZFN0cmluZ1ZhbHVlPiB7XG4gICAgaWYgKCFzeW50YXgpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHN5bnRheC5raW5kKSB7XG4gICAgICBjYXNlIFN5bnRheEtpbmQuU3RyaW5nUHJvcGVydHk6IHtcbiAgICAgICAgY29uc3QgcHJvcGVydHkgPSBzeW50YXggYXMgU3RyaW5nUHJvcGVydHlTeW50YXg7XG4gICAgICAgIGlmIChwcm9wZXJ0eS52YWx1ZSAmJiBwcm9wZXJ0eS52YWx1ZS5raW5kICE9PSBUb2tlbktpbmQuTWlzc2luZykge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gcmVtb3ZlRG91YmxlUXVvdGVzKHByb3BlcnR5LnZhbHVlLnRleHQpO1xuICAgICAgICAgIHJldHVybiBbbmV3IEJvdW5kU3RyaW5nVmFsdWUodmFsdWUsIHByb3BlcnR5LnZhbHVlKV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfVxuICAgICAgY2FzZSBTeW50YXhLaW5kLkFycmF5UHJvcGVydHk6IHtcbiAgICAgICAgcmV0dXJuIChzeW50YXggYXMgQXJyYXlQcm9wZXJ0eVN5bnRheCkuaXRlbXNcbiAgICAgICAgICAuZmlsdGVyKGl0ZW0gPT4gaXRlbS52YWx1ZS5raW5kICE9PSBUb2tlbktpbmQuTWlzc2luZylcbiAgICAgICAgICAubWFwKGl0ZW0gPT4gbmV3IEJvdW5kU3RyaW5nVmFsdWUocmVtb3ZlRG91YmxlUXVvdGVzKGl0ZW0udmFsdWUudGV4dCksIGl0ZW0udmFsdWUpKTtcbiAgICAgIH1cbiAgICAgIGNhc2UgU3ludGF4S2luZC5PYmplY3RQcm9wZXJ0eToge1xuICAgICAgICBiYWcudmFsdWVJc05vdFN0cmluZ09yQXJyYXkoc3ludGF4LmtleS5yYW5nZSk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIFN5bnRheCBraW5kICcke3N5bnRheC5raW5kfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBiaW5kT2JqZWN0KHN5bnRheDogQmFzZVByb3BlcnR5U3ludGF4IHwgdW5kZWZpbmVkKTogUmVhZG9ubHlBcnJheTxCb3VuZE9iamVjdE1lbWJlcj4ge1xuICAgIGlmICghc3ludGF4KSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgc3dpdGNoIChzeW50YXgua2luZCkge1xuICAgICAgY2FzZSBTeW50YXhLaW5kLlN0cmluZ1Byb3BlcnR5OiB7XG4gICAgICAgIGJhZy52YWx1ZUlzTm90QW5PYmplY3Qoc3ludGF4LmtleS5yYW5nZSk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIGNhc2UgU3ludGF4S2luZC5BcnJheVByb3BlcnR5OiB7XG4gICAgICAgIGJhZy52YWx1ZUlzTm90QW5PYmplY3Qoc3ludGF4LmtleS5yYW5nZSk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIGNhc2UgU3ludGF4S2luZC5PYmplY3RQcm9wZXJ0eToge1xuICAgICAgICByZXR1cm4gKHN5bnRheCBhcyBPYmplY3RQcm9wZXJ0eVN5bnRheCkubWVtYmVyc1xuICAgICAgICAgIC5maWx0ZXIobWVtYmVyID0+IG1lbWJlci5uYW1lLmtpbmQgIT09IFRva2VuS2luZC5NaXNzaW5nICYmIG1lbWJlci52YWx1ZS5raW5kICE9PSBUb2tlbktpbmQuTWlzc2luZylcbiAgICAgICAgICAubWFwKG1lbWJlciA9PiBuZXcgQm91bmRPYmplY3RNZW1iZXIobWVtYmVyLm5hbWUudGV4dCwgcmVtb3ZlRG91YmxlUXVvdGVzKG1lbWJlci52YWx1ZS50ZXh0KSwgbWVtYmVyKSk7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBTeW50YXgga2luZCAnJHtzeW50YXgua2luZH0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gcmVtb3ZlRG91YmxlUXVvdGVzKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAoIXZhbHVlLnN0YXJ0c1dpdGgoJ1wiJykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInZhbHVlIGhhcyB0byBzdGFydCB3aXRoIGRvdWJsZSBxdW90ZXNcIik7XG4gICAgfVxuXG4gICAgaWYgKHZhbHVlLmVuZHNXaXRoKCdcIicpKSB7XG4gICAgICByZXR1cm4gdmFsdWUuc3Vic3RyKDEsIHZhbHVlLmxlbmd0aCAtIDIpO1xuICAgIH1cblxuICAgIC8vIGluIGNhc2Ugb2YgYW4gaW5jb21wbGV0ZSB0b2tlblxuICAgIHJldHVybiB2YWx1ZS5zdWJzdHIoMSk7XG4gIH1cbn1cbiJdfQ==
