"use strict";
/*!
 * Copyright 2019 Omar Tawfik. Please see LICENSE file at the root of this repository.
 */
var __values = (this && this.__values) || function (o) {
    var m = typeof Symbol === "function" && o[Symbol.iterator], i = 0;
    if (m) return m.call(o);
    return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
};
Object.defineProperty(exports, "__esModule", { value: true });
var diagnostics_1 = require("./diagnostics");
var scanner_1 = require("../scanning/scanner");
var parser_1 = require("../parsing/parser");
var binder_1 = require("../binding/binder");
var circular_dependencies_1 = require("../analysis/circular-dependencies");
var secrets_1 = require("../analysis/secrets");
var blocks_1 = require("../analysis/blocks");
var actions_1 = require("../analysis/actions");
var ranges_1 = require("./ranges");
var Compilation = /** @class */ (function () {
    function Compilation(text) {
        this.text = text;
        this.bag = new diagnostics_1.DiagnosticBag();
        this.tokens = scanner_1.scanText(text, this.bag);
        this.syntax = parser_1.parseTokens(this.tokens, this.bag);
        this.document = binder_1.bindDocument(this.syntax, this.bag);
        actions_1.analyzeActions(this.document, this.bag);
        blocks_1.analyzeBlocks(this.document, this.bag);
        circular_dependencies_1.analyzeCircularDependencies(this.document, this.bag);
        secrets_1.analyzeSecrets(this.document, this.bag);
    }
    Object.defineProperty(Compilation.prototype, "diagnostics", {
        get: function () {
            return this.bag.diagnostics;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Compilation.prototype, "actions", {
        get: function () {
            var e_1, _a;
            if (!this.lazyActions) {
                this.lazyActions = new Map();
                var _loop_1 = function (node) {
                    var references = Array();
                    this_1.document.actions.forEach(function (action) {
                        if (action.needs) {
                            action.needs.actions.forEach(function (reference) {
                                if (reference.value === node.name) {
                                    references.push(reference.syntax.range);
                                }
                            });
                        }
                    });
                    this_1.document.workflows.forEach(function (workflow) {
                        if (workflow.resolves) {
                            workflow.resolves.actions.forEach(function (reference) {
                                if (reference.value === node.name) {
                                    references.push(reference.syntax.range);
                                }
                            });
                        }
                    });
                    this_1.lazyActions.set(node.name, {
                        references: references,
                        name: node.name,
                        range: node.syntax.name.range,
                    });
                };
                var this_1 = this;
                try {
                    for (var _b = __values(this.document.actions), _c = _b.next(); !_c.done; _c = _b.next()) {
                        var node = _c.value;
                        _loop_1(node);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
            return this.lazyActions;
        },
        enumerable: true,
        configurable: true
    });
    Compilation.prototype.getTargetAt = function (position) {
        var e_2, _a, e_3, _b;
        try {
            for (var _c = __values(this.actions.values()), _d = _c.next(); !_d.done; _d = _c.next()) {
                var action = _d.value;
                if (ranges_1.rangeContains(action.range, position)) {
                    return {
                        name: action.name,
                        range: action.range,
                    };
                }
                try {
                    for (var _e = __values(action.references), _f = _e.next(); !_f.done; _f = _e.next()) {
                        var reference = _f.value;
                        if (ranges_1.rangeContains(reference, position)) {
                            return {
                                name: action.name,
                                range: reference,
                            };
                        }
                    }
                }
                catch (e_3_1) { e_3 = { error: e_3_1 }; }
                finally {
                    try {
                        if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
                    }
                    finally { if (e_3) throw e_3.error; }
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return undefined;
    };
    return Compilation;
}());
exports.Compilation = Compilation;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy91dGlsL2NvbXBpbGF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7Ozs7Ozs7Ozs7O0FBRUgsNkNBQThDO0FBQzlDLCtDQUErQztBQUcvQyw0Q0FBZ0Q7QUFFaEQsNENBQWlEO0FBQ2pELDJFQUFnRjtBQUNoRiwrQ0FBcUQ7QUFDckQsNkNBQW1EO0FBQ25ELCtDQUFxRDtBQUVyRCxtQ0FBeUM7QUFRekM7SUFTRSxxQkFBbUMsSUFBWTtRQUFaLFNBQUksR0FBSixJQUFJLENBQVE7UUFDN0MsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLDJCQUFhLEVBQUUsQ0FBQztRQUUvQixJQUFJLENBQUMsTUFBTSxHQUFHLGtCQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsTUFBTSxHQUFHLG9CQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLFFBQVEsR0FBRyxxQkFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXBELHdCQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEMsc0JBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QyxtREFBMkIsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyRCx3QkFBYyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCxzQkFBVyxvQ0FBVzthQUF0QjtZQUNFLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDOUIsQ0FBQzs7O09BQUE7SUFFRCxzQkFBVyxnQ0FBTzthQUFsQjs7WUFDRSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQzt3Q0FFeEMsSUFBSTtvQkFDYixJQUFNLFVBQVUsR0FBRyxLQUFLLEVBQVMsQ0FBQztvQkFFbEMsT0FBSyxRQUFRLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLE1BQU07d0JBQ2xDLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRTs0QkFDaEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsU0FBUztnQ0FDcEMsSUFBSSxTQUFTLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUU7b0NBQ2pDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztpQ0FDekM7NEJBQ0gsQ0FBQyxDQUFDLENBQUM7eUJBQ0o7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7b0JBRUgsT0FBSyxRQUFRLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFBLFFBQVE7d0JBQ3RDLElBQUksUUFBUSxDQUFDLFFBQVEsRUFBRTs0QkFDckIsUUFBUSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsU0FBUztnQ0FDekMsSUFBSSxTQUFTLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUU7b0NBQ2pDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztpQ0FDekM7NEJBQ0gsQ0FBQyxDQUFDLENBQUM7eUJBQ0o7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7b0JBRUgsT0FBSyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7d0JBQzlCLFVBQVUsWUFBQTt3QkFDVixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7d0JBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUs7cUJBQzlCLENBQUMsQ0FBQzs7OztvQkEzQkwsS0FBbUIsSUFBQSxLQUFBLFNBQUEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUEsZ0JBQUE7d0JBQW5DLElBQU0sSUFBSSxXQUFBO2dDQUFKLElBQUk7cUJBNEJkOzs7Ozs7Ozs7YUFDRjtZQUVELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUMxQixDQUFDOzs7T0FBQTtJQUVNLGlDQUFXLEdBQWxCLFVBQ0UsUUFBa0I7OztZQU9sQixLQUFxQixJQUFBLEtBQUEsU0FBQSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFBLGdCQUFBLDRCQUFFO2dCQUF2QyxJQUFNLE1BQU0sV0FBQTtnQkFDZixJQUFJLHNCQUFhLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsRUFBRTtvQkFDekMsT0FBTzt3QkFDTCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUk7d0JBQ2pCLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztxQkFDcEIsQ0FBQztpQkFDSDs7b0JBRUQsS0FBd0IsSUFBQSxLQUFBLFNBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQSxnQkFBQSw0QkFBRTt3QkFBdEMsSUFBTSxTQUFTLFdBQUE7d0JBQ2xCLElBQUksc0JBQWEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEVBQUU7NEJBQ3RDLE9BQU87Z0NBQ0wsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO2dDQUNqQixLQUFLLEVBQUUsU0FBUzs2QkFDakIsQ0FBQzt5QkFDSDtxQkFDRjs7Ozs7Ozs7O2FBQ0Y7Ozs7Ozs7OztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDSCxrQkFBQztBQUFELENBNUZBLEFBNEZDLElBQUE7QUE1Rlksa0NBQVciLCJmaWxlIjoic3JjL3V0aWwvY29tcGlsYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAyMDE5IE9tYXIgVGF3ZmlrLiBQbGVhc2Ugc2VlIExJQ0VOU0UgZmlsZSBhdCB0aGUgcm9vdCBvZiB0aGlzIHJlcG9zaXRvcnkuXG4gKi9cblxuaW1wb3J0IHsgRGlhZ25vc3RpY0JhZyB9IGZyb20gXCIuL2RpYWdub3N0aWNzXCI7XG5pbXBvcnQgeyBzY2FuVGV4dCB9IGZyb20gXCIuLi9zY2FubmluZy9zY2FubmVyXCI7XG5pbXBvcnQgeyBUb2tlbiB9IGZyb20gXCIuLi9zY2FubmluZy90b2tlbnNcIjtcbmltcG9ydCB7IERvY3VtZW50U3ludGF4IH0gZnJvbSBcIi4uL3BhcnNpbmcvc3ludGF4LW5vZGVzXCI7XG5pbXBvcnQgeyBwYXJzZVRva2VucyB9IGZyb20gXCIuLi9wYXJzaW5nL3BhcnNlclwiO1xuaW1wb3J0IHsgQm91bmREb2N1bWVudCB9IGZyb20gXCIuLi9iaW5kaW5nL2JvdW5kLW5vZGVzXCI7XG5pbXBvcnQgeyBiaW5kRG9jdW1lbnQgfSBmcm9tIFwiLi4vYmluZGluZy9iaW5kZXJcIjtcbmltcG9ydCB7IGFuYWx5emVDaXJjdWxhckRlcGVuZGVuY2llcyB9IGZyb20gXCIuLi9hbmFseXNpcy9jaXJjdWxhci1kZXBlbmRlbmNpZXNcIjtcbmltcG9ydCB7IGFuYWx5emVTZWNyZXRzIH0gZnJvbSBcIi4uL2FuYWx5c2lzL3NlY3JldHNcIjtcbmltcG9ydCB7IGFuYWx5emVCbG9ja3MgfSBmcm9tIFwiLi4vYW5hbHlzaXMvYmxvY2tzXCI7XG5pbXBvcnQgeyBhbmFseXplQWN0aW9ucyB9IGZyb20gXCIuLi9hbmFseXNpcy9hY3Rpb25zXCI7XG5pbXBvcnQgeyBSYW5nZSwgUG9zaXRpb24sIERpYWdub3N0aWMgfSBmcm9tIFwidnNjb2RlLWxhbmd1YWdlc2VydmVyLXR5cGVzXCI7XG5pbXBvcnQgeyByYW5nZUNvbnRhaW5zIH0gZnJvbSBcIi4vcmFuZ2VzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWN0aW9uU3ltYm9sIHtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICByZWFkb25seSByYW5nZTogUmFuZ2U7XG4gIHJlYWRvbmx5IHJlZmVyZW5jZXM6IFJlYWRvbmx5QXJyYXk8UmFuZ2U+O1xufVxuXG5leHBvcnQgY2xhc3MgQ29tcGlsYXRpb24ge1xuICBwcml2YXRlIHJlYWRvbmx5IGJhZzogRGlhZ25vc3RpY0JhZztcblxuICBwcml2YXRlIGxhenlBY3Rpb25zOiBNYXA8c3RyaW5nLCBBY3Rpb25TeW1ib2w+IHwgdW5kZWZpbmVkO1xuXG4gIHB1YmxpYyByZWFkb25seSB0b2tlbnM6IFJlYWRvbmx5QXJyYXk8VG9rZW4+O1xuICBwdWJsaWMgcmVhZG9ubHkgc3ludGF4OiBEb2N1bWVudFN5bnRheDtcbiAgcHVibGljIHJlYWRvbmx5IGRvY3VtZW50OiBCb3VuZERvY3VtZW50O1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgdGV4dDogc3RyaW5nKSB7XG4gICAgdGhpcy5iYWcgPSBuZXcgRGlhZ25vc3RpY0JhZygpO1xuXG4gICAgdGhpcy50b2tlbnMgPSBzY2FuVGV4dCh0ZXh0LCB0aGlzLmJhZyk7XG4gICAgdGhpcy5zeW50YXggPSBwYXJzZVRva2Vucyh0aGlzLnRva2VucywgdGhpcy5iYWcpO1xuICAgIHRoaXMuZG9jdW1lbnQgPSBiaW5kRG9jdW1lbnQodGhpcy5zeW50YXgsIHRoaXMuYmFnKTtcblxuICAgIGFuYWx5emVBY3Rpb25zKHRoaXMuZG9jdW1lbnQsIHRoaXMuYmFnKTtcbiAgICBhbmFseXplQmxvY2tzKHRoaXMuZG9jdW1lbnQsIHRoaXMuYmFnKTtcbiAgICBhbmFseXplQ2lyY3VsYXJEZXBlbmRlbmNpZXModGhpcy5kb2N1bWVudCwgdGhpcy5iYWcpO1xuICAgIGFuYWx5emVTZWNyZXRzKHRoaXMuZG9jdW1lbnQsIHRoaXMuYmFnKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGlhZ25vc3RpY3MoKTogUmVhZG9ubHlBcnJheTxEaWFnbm9zdGljPiB7XG4gICAgcmV0dXJuIHRoaXMuYmFnLmRpYWdub3N0aWNzO1xuICB9XG5cbiAgcHVibGljIGdldCBhY3Rpb25zKCk6IFJlYWRvbmx5TWFwPHN0cmluZywgQWN0aW9uU3ltYm9sPiB7XG4gICAgaWYgKCF0aGlzLmxhenlBY3Rpb25zKSB7XG4gICAgICB0aGlzLmxhenlBY3Rpb25zID0gbmV3IE1hcDxzdHJpbmcsIEFjdGlvblN5bWJvbD4oKTtcblxuICAgICAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMuZG9jdW1lbnQuYWN0aW9ucykge1xuICAgICAgICBjb25zdCByZWZlcmVuY2VzID0gQXJyYXk8UmFuZ2U+KCk7XG5cbiAgICAgICAgdGhpcy5kb2N1bWVudC5hY3Rpb25zLmZvckVhY2goYWN0aW9uID0+IHtcbiAgICAgICAgICBpZiAoYWN0aW9uLm5lZWRzKSB7XG4gICAgICAgICAgICBhY3Rpb24ubmVlZHMuYWN0aW9ucy5mb3JFYWNoKHJlZmVyZW5jZSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZWZlcmVuY2UudmFsdWUgPT09IG5vZGUubmFtZSkge1xuICAgICAgICAgICAgICAgIHJlZmVyZW5jZXMucHVzaChyZWZlcmVuY2Uuc3ludGF4LnJhbmdlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmRvY3VtZW50LndvcmtmbG93cy5mb3JFYWNoKHdvcmtmbG93ID0+IHtcbiAgICAgICAgICBpZiAod29ya2Zsb3cucmVzb2x2ZXMpIHtcbiAgICAgICAgICAgIHdvcmtmbG93LnJlc29sdmVzLmFjdGlvbnMuZm9yRWFjaChyZWZlcmVuY2UgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVmZXJlbmNlLnZhbHVlID09PSBub2RlLm5hbWUpIHtcbiAgICAgICAgICAgICAgICByZWZlcmVuY2VzLnB1c2gocmVmZXJlbmNlLnN5bnRheC5yYW5nZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sYXp5QWN0aW9ucy5zZXQobm9kZS5uYW1lLCB7XG4gICAgICAgICAgcmVmZXJlbmNlcyxcbiAgICAgICAgICBuYW1lOiBub2RlLm5hbWUsXG4gICAgICAgICAgcmFuZ2U6IG5vZGUuc3ludGF4Lm5hbWUucmFuZ2UsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmxhenlBY3Rpb25zO1xuICB9XG5cbiAgcHVibGljIGdldFRhcmdldEF0KFxuICAgIHBvc2l0aW9uOiBQb3NpdGlvbixcbiAgKTpcbiAgICB8IHtcbiAgICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgICByYW5nZTogUmFuZ2U7XG4gICAgICB9XG4gICAgfCB1bmRlZmluZWQge1xuICAgIGZvciAoY29uc3QgYWN0aW9uIG9mIHRoaXMuYWN0aW9ucy52YWx1ZXMoKSkge1xuICAgICAgaWYgKHJhbmdlQ29udGFpbnMoYWN0aW9uLnJhbmdlLCBwb3NpdGlvbikpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBhY3Rpb24ubmFtZSxcbiAgICAgICAgICByYW5nZTogYWN0aW9uLnJhbmdlLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IHJlZmVyZW5jZSBvZiBhY3Rpb24ucmVmZXJlbmNlcykge1xuICAgICAgICBpZiAocmFuZ2VDb250YWlucyhyZWZlcmVuY2UsIHBvc2l0aW9uKSkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBhY3Rpb24ubmFtZSxcbiAgICAgICAgICAgIHJhbmdlOiByZWZlcmVuY2UsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==
